79b5468a8b75b938f6208b60d1723508
/**
 * Command Registry
 *
 * Manages command registration, discovery, and execution.
 * Supports dynamic command loading and plugin architecture.
 */
import { EventEmitter } from 'events';
import { readdir, stat } from 'fs/promises';
import { join, extname } from 'path';
import { BaseCommand } from './base-command.js';
/**
 * Command registry implementation
 */
export class CommandRegistry extends EventEmitter {
    commands = new Map();
    aliases = new Map();
    plugins = new Map();
    loadingPaths = [];
    isInitialized = false;
    /**
     * Initialize the registry
     */
    async initialize() {
        if (this.isInitialized) {
            return;
        }
        this.emit('initializing');
        try {
            // Load plugins first
            await this.loadPlugins();
            // Then load commands from configured paths
            await this.loadCommands();
            this.isInitialized = true;
            this.emit('initialized', {
                commandCount: this.commands.size,
                pluginCount: this.plugins.size
            });
        }
        catch (error) {
            this.emit('initialization-error', error);
            throw error;
        }
    }
    /**
     * Register a command metadata
     */
    register(metadata) {
        if (this.commands.has(metadata.config.name)) {
            throw new Error(`Command '${metadata.config.name}' is already registered`);
        }
        const entry = {
            ...metadata,
            loadTime: Date.now(),
            usageCount: 0
        };
        this.commands.set(metadata.config.name, entry);
        // Register aliases
        if (metadata.config.aliases) {
            for (const alias of metadata.config.aliases) {
                if (this.aliases.has(alias)) {
                    throw new Error(`Alias '${alias}' is already registered`);
                }
                this.aliases.set(alias, metadata.config.name);
            }
        }
        this.emit('command-registered', { name: metadata.config.name, metadata });
    }
    /**
     * Register a BaseCommand instance
     */
    registerCommand(command) {
        this.register(command.metadata);
        // Store the command instance for execution
        const entry = this.commands.get(command.metadata.config.name);
        if (entry) {
            entry.command = command;
        }
    }
    /**
     * Unregister a command
     */
    unregister(name) {
        const entry = this.commands.get(name);
        if (!entry) {
            return false;
        }
        // Remove aliases
        if (entry.config.aliases) {
            for (const alias of entry.config.aliases) {
                this.aliases.delete(alias);
            }
        }
        // Dispose of command resources if it's a BaseCommand
        if (entry.command) {
            entry.command.dispose();
        }
        this.commands.delete(name);
        this.emit('command-unregistered', { name });
        return true;
    }
    /**
     * Get a command metadata by name or alias
     */
    get(name) {
        // Check direct name first
        let entry = this.commands.get(name);
        // Check aliases if not found
        if (!entry) {
            const actualName = this.aliases.get(name);
            if (actualName) {
                entry = this.commands.get(actualName);
            }
        }
        return entry;
    }
    /**
     * Get a BaseCommand instance by name or alias
     */
    getCommand(name) {
        const entry = this.get(name);
        return entry?.command || null;
    }
    /**
     * Check if a command exists
     */
    has(name) {
        return this.commands.has(name) || this.aliases.has(name);
    }
    /**
     * Get all registered commands metadata
     */
    list() {
        return Array.from(this.commands.values())
            .sort((a, b) => a.config.name.localeCompare(b.config.name));
    }
    /**
     * Get commands by category
     */
    findByCategory(category) {
        return this.list().filter(cmd => cmd.config.category === category);
    }
    /**
     * Search commands by name, description, or category
     */
    search(query) {
        const lowerQuery = query.toLowerCase();
        return this.list().filter(cmd => {
            return cmd.config.name.toLowerCase().includes(lowerQuery) ||
                cmd.config.description.toLowerCase().includes(lowerQuery) ||
                cmd.config.category?.toLowerCase().includes(lowerQuery);
        });
    }
    /**
     * Execute a command
     */
    async execute(name, context) {
        const entry = this.get(name);
        if (!entry) {
            return {
                success: false,
                error: `Command '${name}' not found`,
                exitCode: 127,
                executionTime: 0
            };
        }
        // Update usage statistics
        const actualName = this.aliases.get(name) || name;
        const commandEntry = this.commands.get(actualName);
        if (commandEntry) {
            commandEntry.lastUsed = Date.now();
            commandEntry.usageCount++;
        }
        this.emit('command-executing', { name, context });
        try {
            let result;
            // Execute using BaseCommand if available, otherwise use handler
            if (entry.command) {
                result = await entry.command.execute(context);
            }
            else if (entry.handler) {
                result = await entry.handler(context);
            }
            else {
                throw new Error(`No execution method available for command '${name}'`);
            }
            this.emit('command-executed', { name, result });
            return result;
        }
        catch (error) {
            const commandError = error instanceof Error ? error : new Error(String(error));
            this.emit('command-error', { name, error: commandError });
            return {
                success: false,
                error: commandError.message,
                exitCode: 1,
                executionTime: 0
            };
        }
    }
    /**
     * Add command loading path
     */
    addLoadingPath(path) {
        if (!this.loadingPaths.includes(path)) {
            this.loadingPaths.push(path);
        }
    }
    /**
     * Remove command loading path
     */
    removeLoadingPath(path) {
        const index = this.loadingPaths.indexOf(path);
        if (index > -1) {
            this.loadingPaths.splice(index, 1);
        }
    }
    /**
     * Load commands from configured paths
     */
    async loadCommands() {
        const startTime = Date.now();
        const stats = {
            totalCommands: 0,
            loadedCommands: 0,
            failedCommands: 0,
            loadTime: 0,
            errors: []
        };
        for (const loadingPath of this.loadingPaths) {
            try {
                await this.loadCommandsFromPath(loadingPath, stats);
            }
            catch (error) {
                stats.errors.push({
                    path: loadingPath,
                    error: error instanceof Error ? error : new Error(String(error))
                });
                stats.failedCommands++;
            }
        }
        stats.loadTime = Date.now() - startTime;
        this.emit('commands-loaded', stats);
        return stats;
    }
    /**
     * Load commands from a specific path
     */
    async loadCommandsFromPath(path, stats) {
        try {
            const pathStat = await stat(path);
            if (pathStat.isDirectory()) {
                const files = await readdir(path);
                for (const file of files) {
                    const filePath = join(path, file);
                    const fileExt = extname(file);
                    if (['.js', '.ts'].includes(fileExt)) {
                        await this.loadCommandFromFile(filePath, stats);
                    }
                }
            }
            else if (['.js', '.ts'].includes(extname(path))) {
                await this.loadCommandFromFile(path, stats);
            }
        }
        catch (error) {
            stats.errors.push({
                path,
                error: error instanceof Error ? error : new Error(String(error))
            });
            stats.failedCommands++;
        }
    }
    /**
     * Load a command from a file
     */
    async loadCommandFromFile(filePath, stats) {
        try {
            stats.totalCommands++;
            // Dynamic import with proper error handling
            const module = await import(filePath);
            // Look for command exports
            const commandClass = module.default || module.Command;
            if (commandClass && typeof commandClass === 'function') {
                const command = new commandClass();
                if (command instanceof BaseCommand) {
                    this.registerCommand(command);
                    stats.loadedCommands++;
                    this.emit('command-loaded', { path: filePath, name: command.getConfig().name });
                }
                else {
                    throw new Error('Exported class is not a BaseCommand instance');
                }
            }
            else {
                throw new Error('No valid command export found');
            }
        }
        catch (error) {
            stats.errors.push({
                path: filePath,
                error: error instanceof Error ? error : new Error(String(error))
            });
            stats.failedCommands++;
            this.emit('command-load-error', { path: filePath, error });
        }
    }
    /**
     * Register a plugin
     */
    async registerPlugin(plugin) {
        if (this.plugins.has(plugin.name)) {
            throw new Error(`Plugin '${plugin.name}' is already registered`);
        }
        try {
            // Initialize plugin if it has an initialize method
            if (plugin.initialize) {
                await plugin.initialize();
            }
            // Register plugin commands
            for (const commandConfig of plugin.commands) {
                // Create a dynamic command metadata from config
                const metadata = {
                    config: commandConfig,
                    handler: async (context) => {
                        // This is a placeholder - real plugins would provide actual handlers
                        return {
                            success: true,
                            message: `Dynamic command '${commandConfig.name}' executed`,
                            exitCode: 0
                        };
                    },
                    registeredAt: new Date(),
                    available: true,
                    plugin: plugin.name
                };
                this.register(metadata);
            }
            this.plugins.set(plugin.name, plugin);
            this.emit('plugin-registered', { name: plugin.name, version: plugin.version });
        }
        catch (error) {
            this.emit('plugin-error', { name: plugin.name, error });
            throw error;
        }
    }
    /**
     * Unregister a plugin
     */
    async unregisterPlugin(name) {
        const plugin = this.plugins.get(name);
        if (!plugin) {
            return false;
        }
        try {
            // Unregister plugin commands
            for (const commandConfig of plugin.commands) {
                this.unregister(commandConfig.name);
            }
            // Dispose plugin if it has a dispose method
            if (plugin.dispose) {
                await plugin.dispose();
            }
            this.plugins.delete(name);
            this.emit('plugin-unregistered', { name });
            return true;
        }
        catch (error) {
            this.emit('plugin-error', { name, error });
            throw error;
        }
    }
    /**
     * Load plugins from configuration
     */
    async loadPlugins() {
        // This would load plugins from configuration files or plugin directories
        // For now, this is a placeholder
        this.emit('plugins-loaded', { count: 0 });
    }
    /**
     * Get usage statistics
     */
    getUsageStats() {
        return Array.from(this.commands.entries()).map(([name, entry]) => ({
            name,
            usageCount: entry.usageCount,
            lastUsed: entry.lastUsed
        }));
    }
    /**
     * Clear all commands and plugins
     */
    async clear() {
        // Unregister all plugins
        for (const pluginName of this.plugins.keys()) {
            await this.unregisterPlugin(pluginName);
        }
        // Unregister all commands
        for (const commandName of this.commands.keys()) {
            this.unregister(commandName);
        }
        this.aliases.clear();
        this.isInitialized = false;
        this.emit('cleared');
    }
    /**
     * Get registry status
     */
    getStatus() {
        return {
            initialized: this.isInitialized,
            commandCount: this.commands.size,
            pluginCount: this.plugins.size,
            aliasCount: this.aliases.size,
            loadingPaths: [...this.loadingPaths]
        };
    }
    /**
     * Dispose of registry resources
     */
    async dispose() {
        await this.clear();
        this.removeAllListeners();
        this.loadingPaths.length = 0;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWh1Z28vY29kZS9jbGF1ZGUtY29kZS1mbG93L3NyYy9jbGkvY29yZS9jb21tYW5kLXJlZ2lzdHJ5LnRzIiwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUN0QyxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM1QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVNyQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFrQ2hEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGVBQWdCLFNBQVEsWUFBWTtJQUN2QyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQXdCLENBQUM7SUFDM0MsT0FBTyxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0lBQ3BDLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBeUIsQ0FBQztJQUMzQyxZQUFZLEdBQWEsRUFBRSxDQUFDO0lBQzVCLGFBQWEsR0FBRyxLQUFLLENBQUM7SUFFOUI7O09BRUc7SUFDSCxLQUFLLENBQUMsVUFBVTtRQUNkLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3ZCLE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUUxQixJQUFJLENBQUM7WUFDSCxxQkFBcUI7WUFDckIsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFekIsMkNBQTJDO1lBQzNDLE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBRTFCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1lBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO2dCQUN2QixZQUFZLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJO2dCQUNoQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJO2FBQy9CLENB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LEdBQUcsQ0FBQyxDQUFDO0lBQy9CLENBQUM7Q0FDRiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9taHVnby9jb2RlL2NsYXVkZS1jb2RlLWZsb3cvc3JjL2NsaS9jb3JlL2NvbW1hbmQtcmVnaXN0cnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb21tYW5kIFJlZ2lzdHJ5XG4gKiBcbiAqIE1hbmFnZXMgY29tbWFuZCByZWdpc3RyYXRpb24sIGRpc2NvdmVyeSwgYW5kIGV4ZWN1dGlvbi5cbiAqIFN1cHBvcnRzIGR5bmFtaWMgY29tbWFuZCBsb2FkaW5nIGFuZCBwbHVnaW4gYXJjaGl0ZWN0dXJlLlxuICovXG5cbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyByZWFkZGlyLCBzdGF0IH0gZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHsgam9pbiwgZXh0bmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHR5cGUge1xuICBDb21tYW5kQ29uZmlnLFxuICBDb21tYW5kQ29udGV4dCxcbiAgQ29tbWFuZFJlc3VsdCxcbiAgQ29tbWFuZFJlZ2lzdHJ5IGFzIElDb21tYW5kUmVnaXN0cnksXG4gIENvbW1hbmRNZXRhZGF0YSxcbiAgQXN5bmNSZXN1bHRcbn0gZnJvbSAnLi4vdHlwZXMvaW5kZXguanMnO1xuaW1wb3J0IHsgQmFzZUNvbW1hbmQgfSBmcm9tICcuL2Jhc2UtY29tbWFuZC5qcyc7XG5cbi8qKlxuICogQ29tbWFuZCByZWdpc3RyYXRpb24gZW50cnlcbiAqL1xuaW50ZXJmYWNlIENvbW1hbmRFbnRyeSBleHRlbmRzIENvbW1hbmRNZXRhZGF0YSB7XG4gIGNvbW1hbmQ/OiBCYXNlQ29tbWFuZDtcbiAgbG9hZFRpbWU6IG51bWJlcjtcbiAgbGFzdFVzZWQ/OiBudW1iZXI7XG4gIHVzYWdlQ291bnQ6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDb21tYW5kIGxvYWRpbmcgc3RhdGlzdGljc1xuICovXG5pbnRlcmZhY2UgTG9hZGluZ1N0YXRzIHtcbiAgdG90YWxDb21tYW5kczogbnVtYmVyO1xuICBsb2FkZWRDb21tYW5kczogbnVtYmVyO1xuICBmYWlsZWRDb21tYW5kczogbnVtYmVyO1xuICBsb2FkVGltZTogbnVtYmVyO1xuICBlcnJvcnM6IEFycmF5PHsgcGF0aDogc3RyaW5nOyBlcnJvcjogRXJyb3IgfT47XG59XG5cbi8qKlxuICogUGx1Z2luIGludGVyZmFjZSBmb3IgY29tbWFuZCBleHRlbnNpb25zXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29tbWFuZFBsdWdpbiB7XG4gIG5hbWU6IHN0cmluZztcbiAgdmVyc2lvbjogc3RyaW5nO1xuICBjb21tYW5kczogQ29tbWFuZENvbmZpZ1tdO1xuICBpbml0aWFsaXplPygpOiBQcm9taXNlPHZvaWQ+IHwgdm9pZDtcbiAgZGlzcG9zZT8oKTogUHJvbWlzZTx2b2lkPiB8IHZvaWQ7XG59XG5cbi8qKlxuICogQ29tbWFuZCByZWdpc3RyeSBpbXBsZW1lbnRhdGlvblxuICovXG5leHBvcnQgY2xhc3MgQ29tbWFuZFJlZ2lzdHJ5IGV4dGVuZHMgRXZlbnRFbWl0dGVyIGltcGxlbWVudHMgSUNvbW1hbmRSZWdpc3RyeSB7XG4gIHByaXZhdGUgY29tbWFuZHMgPSBuZXcgTWFwPHN0cmluZywgQ29tbWFuZEVudHJ5PigpO1xuICBwcml2YXRlIGFsaWFzZXMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICBwcml2YXRlIHBsdWdpbnMgPSBuZXcgTWFwPHN0cmluZywgQ29tbWFuZFBsdWdpbj4oKTtcbiAgcHJpdmF0ZSBsb2FkaW5nUGF0aHM6IHN0cmluZ1tdID0gW107XG4gIHByaXZhdGUgaXNJbml0aWFsaXplZCA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIHRoZSByZWdpc3RyeVxuICAgKi9cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5pc0luaXRpYWxpemVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5lbWl0KCdpbml0aWFsaXppbmcnKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgLy8gTG9hZCBwbHVnaW5zIGZpcnN0XG4gICAgICBhd2FpdCB0aGlzLmxvYWRQbHVnaW5zKCk7XG4gICAgICBcbiAgICAgIC8vIFRoZW4gbG9hZCBjb21tYW5kcyBmcm9tIGNvbmZpZ3VyZWQgcGF0aHNcbiAgICAgIGF3YWl0IHRoaXMubG9hZENvbW1hbmRzKCk7XG4gICAgICBcbiAgICAgIHRoaXMuaXNJbml0aWFsaXplZCA9IHRydWU7XG4gICAgICB0aGlzLmVtaXQoJ2luaXRpYWxpemVkJywge1xuICAgICAgICBjb21tYW5kQ291bnQ6IHRoaXMuY29tbWFuZHMuc2l6ZSxcbiAgICAgICAgcGx1Z2luQ291bnQ6IHRoaXMucGx1Z2lucy5zaXplXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5lbWl0KCdpbml0aWFsaXphdGlvbi1lcnJvcicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIGNvbW1hbmQgbWV0YWRhdGFcbiAgICovXG4gIHJlZ2lzdGVyKG1ldGFkYXRhOiBDb21tYW5kTWV0YWRhdGEpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jb21tYW5kcy5oYXMobWV0YWRhdGEuY29uZmlnLm5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbW1hbmQgJyR7bWV0YWRhdGEuY29uZmlnLm5hbWV9JyBpcyBhbHJlYWR5IHJlZ2lzdGVyZWRgKTtcbiAgICB9XG5cbiAgICBjb25zdCBlbnRyeTogQ29tbWFuZEVudHJ5ID0ge1xuICAgICAgLi4ubWV0YWRhdGEsXG4gICAgICBsb2FkVGltZTogRGF0ZS5ub3coKSxcbiAgICAgIHVzYWdlQ291bnQ6IDBcbiAgICB9O1xuXG4gICAgdGhpcy5jb21tYW5kcy5zZXQobWV0YWRhdGEuY29uZmlnLm5hbWUsIGVudHJ5KTtcblxuICAgIC8vIFJlZ2lzdGVyIGFsaWFzZXNcbiAgICBpZiAobWV0YWRhdGEuY29uZmlnLmFsaWFzZXMpIHtcbiAgICAgIGZvciAoY29uc3QgYWxpYXMgb2YgbWV0YWRhdGEuY29uZmlnLmFsaWFzZXMpIHtcbiAgICAgICAgaWYgKHRoaXMuYWxpYXNlcy5oYXMoYWxpYXMpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBbGlhcyAnJHthbGlhc30nIGlzIGFscmVhZHkgcmVnaXN0ZXJlZGApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYWxpYXNlcy5zZXQoYWxpYXMsIG1ldGFkYXRhLmNvbmZpZy5uYW1lKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmVtaXQoJ2NvbW1hbmQtcmVnaXN0ZXJlZCcsIHsgbmFtZTogbWV0YWRhdGEuY29uZmlnLm5hbWUsIG1ldGFkYXRhIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGEgQmFzZUNvbW1hbmQgaW5zdGFuY2VcbiAgICovXG4gIHJlZ2lzdGVyQ29tbWFuZChjb21tYW5kOiBCYXNlQ29tbWFuZCk6IHZvaWQge1xuICAgIHRoaXMucmVnaXN0ZXIoY29tbWFuZC5tZXRhZGF0YSk7XG4gICAgXG4gICAgLy8gU3RvcmUgdGhlIGNvbW1hbmQgaW5zdGFuY2UgZm9yIGV4ZWN1dGlvblxuICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5jb21tYW5kcy5nZXQoY29tbWFuZC5tZXRhZGF0YS5jb25maWcubmFtZSk7XG4gICAgaWYgKGVudHJ5KSB7XG4gICAgICBlbnRyeS5jb21tYW5kID0gY29tbWFuZDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVW5yZWdpc3RlciBhIGNvbW1hbmRcbiAgICovXG4gIHVucmVnaXN0ZXIobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNvbW1hbmRzLmdldChuYW1lKTtcbiAgICBpZiAoIWVudHJ5KSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gUmVtb3ZlIGFsaWFzZXNcbiAgICBpZiAoZW50cnkuY29uZmlnLmFsaWFzZXMpIHtcbiAgICAgIGZvciAoY29uc3QgYWxpYXMgb2YgZW50cnkuY29uZmlnLmFsaWFzZXMpIHtcbiAgICAgICAgdGhpcy5hbGlhc2VzLmRlbGV0ZShhbGlhcyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRGlzcG9zZSBvZiBjb21tYW5kIHJlc291cmNlcyBpZiBpdCdzIGEgQmFzZUNvbW1hbmRcbiAgICBpZiAoZW50cnkuY29tbWFuZCkge1xuICAgICAgZW50cnkuY29tbWFuZC5kaXNwb3NlKCk7XG4gICAgfVxuICAgIFxuICAgIHRoaXMuY29tbWFuZHMuZGVsZXRlKG5hbWUpO1xuICAgIHRoaXMuZW1pdCgnY29tbWFuZC11bnJlZ2lzdGVyZWQnLCB7IG5hbWUgfSk7XG4gICAgXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgY29tbWFuZCBtZXRhZGF0YSBieSBuYW1lIG9yIGFsaWFzXG4gICAqL1xuICBnZXQobmFtZTogc3RyaW5nKTogQ29tbWFuZE1ldGFkYXRhIHwgdW5kZWZpbmVkIHtcbiAgICAvLyBDaGVjayBkaXJlY3QgbmFtZSBmaXJzdFxuICAgIGxldCBlbnRyeSA9IHRoaXMuY29tbWFuZHMuZ2V0KG5hbWUpO1xuICAgIFxuICAgIC8vIENoZWNrIGFsaWFzZXMgaWYgbm90IGZvdW5kXG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgY29uc3QgYWN0dWFsTmFtZSA9IHRoaXMuYWxpYXNlcy5nZXQobmFtZSk7XG4gICAgICBpZiAoYWN0dWFsTmFtZSkge1xuICAgICAgICBlbnRyeSA9IHRoaXMuY29tbWFuZHMuZ2V0KGFjdHVhbE5hbWUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlbnRyeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSBCYXNlQ29tbWFuZCBpbnN0YW5jZSBieSBuYW1lIG9yIGFsaWFzXG4gICAqL1xuICBnZXRDb21tYW5kKG5hbWU6IHN0cmluZyk6IEJhc2VDb21tYW5kIHwgbnVsbCB7XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmdldChuYW1lKSBhcyBDb21tYW5kRW50cnk7XG4gICAgcmV0dXJuIGVudHJ5Py5jb21tYW5kIHx8IG51bGw7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgYSBjb21tYW5kIGV4aXN0c1xuICAgKi9cbiAgaGFzKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmNvbW1hbmRzLmhhcyhuYW1lKSB8fCB0aGlzLmFsaWFzZXMuaGFzKG5hbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbGwgcmVnaXN0ZXJlZCBjb21tYW5kcyBtZXRhZGF0YVxuICAgKi9cbiAgbGlzdCgpOiBDb21tYW5kTWV0YWRhdGFbXSB7XG4gICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5jb21tYW5kcy52YWx1ZXMoKSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBhLmNvbmZpZy5uYW1lLmxvY2FsZUNvbXBhcmUoYi5jb25maWcubmFtZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjb21tYW5kcyBieSBjYXRlZ29yeVxuICAgKi9cbiAgZmluZEJ5Q2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZyk6IENvbW1hbmRNZXRhZGF0YVtdIHtcbiAgICByZXR1cm4gdGhpcy5saXN0KCkuZmlsdGVyKGNtZCA9PiBjbWQuY29uZmlnLmNhdGVnb3J5ID09PSBjYXRlZ29yeSk7XG4gIH1cblxuICAvKipcbiAgICogU2VhcmNoIGNvbW1hbmRzIGJ5IG5hbWUsIGRlc2NyaXB0aW9uLCBvciBjYXRlZ29yeVxuICAgKi9cbiAgc2VhcmNoKHF1ZXJ5OiBzdHJpbmcpOiBDb21tYW5kTWV0YWRhdGFbXSB7XG4gICAgY29uc3QgbG93ZXJRdWVyeSA9IHF1ZXJ5LnRvTG93ZXJDYXNlKCk7XG4gICAgXG4gICAgcmV0dXJuIHRoaXMubGlzdCgpLmZpbHRlcihjbWQgPT4ge1xuICAgICAgcmV0dXJuIGNtZC5jb25maWcubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGxvd2VyUXVlcnkpIHx8XG4gICAgICAgICAgICAgY21kLmNvbmZpZy5kZXNjcmlwdGlvbi50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGxvd2VyUXVlcnkpIHx8XG4gICAgICAgICAgICAgY21kLmNvbmZpZy5jYXRlZ29yeT8udG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhsb3dlclF1ZXJ5KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeGVjdXRlIGEgY29tbWFuZFxuICAgKi9cbiAgYXN5bmMgZXhlY3V0ZShuYW1lOiBzdHJpbmcsIGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KTogUHJvbWlzZTxDb21tYW5kUmVzdWx0PiB7XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmdldChuYW1lKSBhcyBDb21tYW5kRW50cnk7XG4gICAgXG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBgQ29tbWFuZCAnJHtuYW1lfScgbm90IGZvdW5kYCxcbiAgICAgICAgZXhpdENvZGU6IDEyNyxcbiAgICAgICAgZXhlY3V0aW9uVGltZTogMFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgdXNhZ2Ugc3RhdGlzdGljc1xuICAgIGNvbnN0IGFjdHVhbE5hbWUgPSB0aGlzLmFsaWFzZXMuZ2V0KG5hbWUpIHx8IG5hbWU7XG4gICAgY29uc3QgY29tbWFuZEVudHJ5ID0gdGhpcy5jb21tYW5kcy5nZXQoYWN0dWFsTmFtZSk7XG4gICAgaWYgKGNvbW1hbmRFbnRyeSkge1xuICAgICAgY29tbWFuZEVudHJ5Lmxhc3RVc2VkID0gRGF0ZS5ub3coKTtcbiAgICAgIGNvbW1hbmRFbnRyeS51c2FnZUNvdW50Kys7XG4gICAgfVxuXG4gICAgdGhpcy5lbWl0KCdjb21tYW5kLWV4ZWN1dGluZycsIHsgbmFtZSwgY29udGV4dCB9KTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgbGV0IHJlc3VsdDogQ29tbWFuZFJlc3VsdDtcblxuICAgICAgLy8gRXhlY3V0ZSB1c2luZyBCYXNlQ29tbWFuZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSB1c2UgaGFuZGxlclxuICAgICAgaWYgKGVudHJ5LmNvbW1hbmQpIHtcbiAgICAgICAgcmVzdWx0ID0gYXdhaXQgZW50cnkuY29tbWFuZC5leGVjdXRlKGNvbnRleHQpO1xuICAgICAgfSBlbHNlIGlmIChlbnRyeS5oYW5kbGVyKSB7XG4gICAgICAgIHJlc3VsdCA9IGF3YWl0IGVudHJ5LmhhbmRsZXIoY29udGV4dCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGV4ZWN1dGlvbiBtZXRob2QgYXZhaWxhYmxlIGZvciBjb21tYW5kICcke25hbWV9J2ApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmVtaXQoJ2NvbW1hbmQtZXhlY3V0ZWQnLCB7IG5hbWUsIHJlc3VsdCB9KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IGNvbW1hbmRFcnJvciA9IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKTtcbiAgICAgIHRoaXMuZW1pdCgnY29tbWFuZC1lcnJvcicsIHsgbmFtZSwgZXJyb3I6IGNvbW1hbmRFcnJvciB9KTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBjb21tYW5kRXJyb3IubWVzc2FnZSxcbiAgICAgICAgZXhpdENvZGU6IDEsXG4gICAgICAgIGV4ZWN1dGlvblRpbWU6IDBcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBjb21tYW5kIGxvYWRpbmcgcGF0aFxuICAgKi9cbiAgYWRkTG9hZGluZ1BhdGgocGF0aDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmxvYWRpbmdQYXRocy5pbmNsdWRlcyhwYXRoKSkge1xuICAgICAgdGhpcy5sb2FkaW5nUGF0aHMucHVzaChwYXRoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGNvbW1hbmQgbG9hZGluZyBwYXRoXG4gICAqL1xuICByZW1vdmVMb2FkaW5nUGF0aChwYXRoOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMubG9hZGluZ1BhdGhzLmluZGV4T2YocGF0aCk7XG4gICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgIHRoaXMubG9hZGluZ1BhdGhzLnNwbGljZShpbmRleCwgMSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgY29tbWFuZHMgZnJvbSBjb25maWd1cmVkIHBhdGhzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGxvYWRDb21tYW5kcygpOiBQcm9taXNlPExvYWRpbmdTdGF0cz4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgY29uc3Qgc3RhdHM6IExvYWRpbmdTdGF0cyA9IHtcbiAgICAgIHRvdGFsQ29tbWFuZHM6IDAsXG4gICAgICBsb2FkZWRDb21tYW5kczogMCxcbiAgICAgIGZhaWxlZENvbW1hbmRzOiAwLFxuICAgICAgbG9hZFRpbWU6IDAsXG4gICAgICBlcnJvcnM6IFtdXG4gICAgfTtcblxuICAgIGZvciAoY29uc3QgbG9hZGluZ1BhdGggb2YgdGhpcy5sb2FkaW5nUGF0aHMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMubG9hZENvbW1hbmRzRnJvbVBhdGgobG9hZGluZ1BhdGgsIHN0YXRzKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHN0YXRzLmVycm9ycy5wdXNoKHtcbiAgICAgICAgICBwYXRoOiBsb2FkaW5nUGF0aCxcbiAgICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogbmV3IEVycm9yKFN0cmluZyhlcnJvcikpXG4gICAgICAgIH0pO1xuICAgICAgICBzdGF0cy5mYWlsZWRDb21tYW5kcysrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRzLmxvYWRUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICB0aGlzLmVtaXQoJ2NvbW1hbmRzLWxvYWRlZCcsIHN0YXRzKTtcbiAgICBcbiAgICByZXR1cm4gc3RhdHM7XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBjb21tYW5kcyBmcm9tIGEgc3BlY2lmaWMgcGF0aFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBsb2FkQ29tbWFuZHNGcm9tUGF0aChwYXRoOiBzdHJpbmcsIHN0YXRzOiBMb2FkaW5nU3RhdHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcGF0aFN0YXQgPSBhd2FpdCBzdGF0KHBhdGgpO1xuICAgICAgXG4gICAgICBpZiAocGF0aFN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICBjb25zdCBmaWxlcyA9IGF3YWl0IHJlYWRkaXIocGF0aCk7XG4gICAgICAgIFxuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgICBjb25zdCBmaWxlUGF0aCA9IGpvaW4ocGF0aCwgZmlsZSk7XG4gICAgICAgICAgY29uc3QgZmlsZUV4dCA9IGV4dG5hbWUoZmlsZSk7XG4gICAgICAgICAgXG4gICAgICAgICAgaWYgKFsnLmpzJywgJy50cyddLmluY2x1ZGVzKGZpbGVFeHQpKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRDb21tYW5kRnJvbUZpbGUoZmlsZVBhdGgsIHN0YXRzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoWycuanMnLCAnLnRzJ10uaW5jbHVkZXMoZXh0bmFtZShwYXRoKSkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ29tbWFuZEZyb21GaWxlKHBhdGgsIHN0YXRzKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgc3RhdHMuZXJyb3JzLnB1c2goe1xuICAgICAgICBwYXRoLFxuICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogbmV3IEVycm9yKFN0cmluZyhlcnJvcikpXG4gICAgICB9KTtcbiAgICAgIHN0YXRzLmZhaWxlZENvbW1hbmRzKys7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgYSBjb21tYW5kIGZyb20gYSBmaWxlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGxvYWRDb21tYW5kRnJvbUZpbGUoZmlsZVBhdGg6IHN0cmluZywgc3RhdHM6IExvYWRpbmdTdGF0cyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBzdGF0cy50b3RhbENvbW1hbmRzKys7XG4gICAgICBcbiAgICAgIC8vIER5bmFtaWMgaW1wb3J0IHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nXG4gICAgICBjb25zdCBtb2R1bGUgPSBhd2FpdCBpbXBvcnQoZmlsZVBhdGgpO1xuICAgICAgXG4gICAgICAvLyBMb29rIGZvciBjb21tYW5kIGV4cG9ydHNcbiAgICAgIGNvbnN0IGNvbW1hbmRDbGFzcyA9IG1vZHVsZS5kZWZhdWx0IHx8IG1vZHVsZS5Db21tYW5kO1xuICAgICAgXG4gICAgICBpZiAoY29tbWFuZENsYXNzICYmIHR5cGVvZiBjb21tYW5kQ2xhc3MgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBjb21tYW5kQ2xhc3MoKSBhcyBCYXNlQ29tbWFuZDtcbiAgICAgICAgXG4gICAgICAgIGlmIChjb21tYW5kIGluc3RhbmNlb2YgQmFzZUNvbW1hbmQpIHtcbiAgICAgICAgICB0aGlzLnJlZ2lzdGVyQ29tbWFuZChjb21tYW5kKTtcbiAgICAgICAgICBzdGF0cy5sb2FkZWRDb21tYW5kcysrO1xuICAgICAgICAgIHRoaXMuZW1pdCgnY29tbWFuZC1sb2FkZWQnLCB7IHBhdGg6IGZpbGVQYXRoLCBuYW1lOiBjb21tYW5kLmdldENvbmZpZygpLm5hbWUgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFeHBvcnRlZCBjbGFzcyBpcyBub3QgYSBCYXNlQ29tbWFuZCBpbnN0YW5jZScpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZhbGlkIGNvbW1hbmQgZXhwb3J0IGZvdW5kJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHN0YXRzLmVycm9ycy5wdXNoKHtcbiAgICAgICAgcGF0aDogZmlsZVBhdGgsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBuZXcgRXJyb3IoU3RyaW5nKGVycm9yKSlcbiAgICAgIH0pO1xuICAgICAgc3RhdHMuZmFpbGVkQ29tbWFuZHMrKztcbiAgICAgIHRoaXMuZW1pdCgnY29tbWFuZC1sb2FkLWVycm9yJywgeyBwYXRoOiBmaWxlUGF0aCwgZXJyb3IgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGEgcGx1Z2luXG4gICAqL1xuICBhc3luYyByZWdpc3RlclBsdWdpbihwbHVnaW46IENvbW1hbmRQbHVnaW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5wbHVnaW5zLmhhcyhwbHVnaW4ubmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUGx1Z2luICcke3BsdWdpbi5uYW1lfScgaXMgYWxyZWFkeSByZWdpc3RlcmVkYCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEluaXRpYWxpemUgcGx1Z2luIGlmIGl0IGhhcyBhbiBpbml0aWFsaXplIG1ldGhvZFxuICAgICAgaWYgKHBsdWdpbi5pbml0aWFsaXplKSB7XG4gICAgICAgIGF3YWl0IHBsdWdpbi5pbml0aWFsaXplKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFJlZ2lzdGVyIHBsdWdpbiBjb21tYW5kc1xuICAgICAgZm9yIChjb25zdCBjb21tYW5kQ29uZmlnIG9mIHBsdWdpbi5jb21tYW5kcykge1xuICAgICAgICAvLyBDcmVhdGUgYSBkeW5hbWljIGNvbW1hbmQgbWV0YWRhdGEgZnJvbSBjb25maWdcbiAgICAgICAgY29uc3QgbWV0YWRhdGE6IENvbW1hbmRNZXRhZGF0YSA9IHtcbiAgICAgICAgICBjb25maWc6IGNvbW1hbmRDb25maWcsXG4gICAgICAgICAgaGFuZGxlcjogYXN5bmMgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KTogUHJvbWlzZTxDb21tYW5kUmVzdWx0PiA9PiB7XG4gICAgICAgICAgICAvLyBUaGlzIGlzIGEgcGxhY2Vob2xkZXIgLSByZWFsIHBsdWdpbnMgd291bGQgcHJvdmlkZSBhY3R1YWwgaGFuZGxlcnNcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBEeW5hbWljIGNvbW1hbmQgJyR7Y29tbWFuZENvbmZpZy5uYW1lfScgZXhlY3V0ZWRgLFxuICAgICAgICAgICAgICBleGl0Q29kZTogMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHJlZ2lzdGVyZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICBhdmFpbGFibGU6IHRydWUsXG4gICAgICAgICAgcGx1Z2luOiBwbHVnaW4ubmFtZVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgdGhpcy5yZWdpc3RlcihtZXRhZGF0YSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMucGx1Z2lucy5zZXQocGx1Z2luLm5hbWUsIHBsdWdpbik7XG4gICAgICB0aGlzLmVtaXQoJ3BsdWdpbi1yZWdpc3RlcmVkJywgeyBuYW1lOiBwbHVnaW4ubmFtZSwgdmVyc2lvbjogcGx1Z2luLnZlcnNpb24gfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuZW1pdCgncGx1Z2luLWVycm9yJywgeyBuYW1lOiBwbHVnaW4ubmFtZSwgZXJyb3IgfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVW5yZWdpc3RlciBhIHBsdWdpblxuICAgKi9cbiAgYXN5bmMgdW5yZWdpc3RlclBsdWdpbihuYW1lOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBwbHVnaW4gPSB0aGlzLnBsdWdpbnMuZ2V0KG5hbWUpO1xuICAgIGlmICghcGx1Z2luKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFVucmVnaXN0ZXIgcGx1Z2luIGNvbW1hbmRzXG4gICAgICBmb3IgKGNvbnN0IGNvbW1hbmRDb25maWcgb2YgcGx1Z2luLmNvbW1hbmRzKSB7XG4gICAgICAgIHRoaXMudW5yZWdpc3Rlcihjb21tYW5kQ29uZmlnLm5hbWUpO1xuICAgICAgfVxuXG4gICAgICAvLyBEaXNwb3NlIHBsdWdpbiBpZiBpdCBoYXMgYSBkaXNwb3NlIG1ldGhvZFxuICAgICAgaWYgKHBsdWdpbi5kaXNwb3NlKSB7XG4gICAgICAgIGF3YWl0IHBsdWdpbi5kaXNwb3NlKCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMucGx1Z2lucy5kZWxldGUobmFtZSk7XG4gICAgICB0aGlzLmVtaXQoJ3BsdWdpbi11bnJlZ2lzdGVyZWQnLCB7IG5hbWUgfSk7XG4gICAgICBcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmVtaXQoJ3BsdWdpbi1lcnJvcicsIHsgbmFtZSwgZXJyb3IgfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBwbHVnaW5zIGZyb20gY29uZmlndXJhdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBsb2FkUGx1Z2lucygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBUaGlzIHdvdWxkIGxvYWQgcGx1Z2lucyBmcm9tIGNvbmZpZ3VyYXRpb24gZmlsZXMgb3IgcGx1Z2luIGRpcmVjdG9yaWVzXG4gICAgLy8gRm9yIG5vdywgdGhpcyBpcyBhIHBsYWNlaG9sZGVyXG4gICAgdGhpcy5lbWl0KCdwbHVnaW5zLWxvYWRlZCcsIHsgY291bnQ6IDAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHVzYWdlIHN0YXRpc3RpY3NcbiAgICovXG4gIGdldFVzYWdlU3RhdHMoKTogQXJyYXk8eyBuYW1lOiBzdHJpbmc7IHVzYWdlQ291bnQ6IG51bWJlcjsgbGFzdFVzZWQ/OiBudW1iZXIgfT4ge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuY29tbWFuZHMuZW50cmllcygpKS5tYXAoKFtuYW1lLCBlbnRyeV0pID0+ICh7XG4gICAgICBuYW1lLFxuICAgICAgdXNhZ2VDb3VudDogZW50cnkudXNhZ2VDb3VudCxcbiAgICAgIGxhc3RVc2VkOiBlbnRyeS5sYXN0VXNlZFxuICAgIH0pKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBhbGwgY29tbWFuZHMgYW5kIHBsdWdpbnNcbiAgICovXG4gIGFzeW5jIGNsZWFyKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIFVucmVnaXN0ZXIgYWxsIHBsdWdpbnNcbiAgICBmb3IgKGNvbnN0IHBsdWdpbk5hbWUgb2YgdGhpcy5wbHVnaW5zLmtleXMoKSkge1xuICAgICAgYXdhaXQgdGhpcy51bnJlZ2lzdGVyUGx1Z2luKHBsdWdpbk5hbWUpO1xuICAgIH1cblxuICAgIC8vIFVucmVnaXN0ZXIgYWxsIGNvbW1hbmRzXG4gICAgZm9yIChjb25zdCBjb21tYW5kTmFtZSBvZiB0aGlzLmNvbW1hbmRzLmtleXMoKSkge1xuICAgICAgdGhpcy51bnJlZ2lzdGVyKGNvbW1hbmROYW1lKTtcbiAgICB9XG5cbiAgICB0aGlzLmFsaWFzZXMuY2xlYXIoKTtcbiAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICBcbiAgICB0aGlzLmVtaXQoJ2NsZWFyZWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcmVnaXN0cnkgc3RhdHVzXG4gICAqL1xuICBnZXRTdGF0dXMoKToge1xuICAgIGluaXRpYWxpemVkOiBib29sZWFuO1xuICAgIGNvbW1hbmRDb3VudDogbnVtYmVyO1xuICAgIHBsdWdpbkNvdW50OiBudW1iZXI7XG4gICAgYWxpYXNDb3VudDogbnVtYmVyO1xuICAgIGxvYWRpbmdQYXRoczogc3RyaW5nW107XG4gIH0ge1xuICAgIHJldHVybiB7XG4gICAgICBpbml0aWFsaXplZDogdGhpcy5pc0luaXRpYWxpemVkLFxuICAgICAgY29tbWFuZENvdW50OiB0aGlzLmNvbW1hbmRzLnNpemUsXG4gICAgICBwbHVnaW5Db3VudDogdGhpcy5wbHVnaW5zLnNpemUsXG4gICAgICBhbGlhc0NvdW50OiB0aGlzLmFsaWFzZXMuc2l6ZSxcbiAgICAgIGxvYWRpbmdQYXRoczogWy4uLnRoaXMubG9hZGluZ1BhdGhzXVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRGlzcG9zZSBvZiByZWdpc3RyeSByZXNvdXJjZXNcbiAgICovXG4gIGFzeW5jIGRpc3Bvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5jbGVhcigpO1xuICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgdGhpcy5sb2FkaW5nUGF0aHMubGVuZ3RoID0gMDtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==