2e55bc2cca5200a5e589896271b859a1
/**
 * Database Test Helper - Database Testing Utilities
 *
 * Comprehensive database testing support for integration tests
 */
import { promises as fs } from 'fs';
import { join } from 'path';
import { tmpdir } from 'os';
export class SQLiteDatabaseTestHelper {
    dbPath;
    db = null;
    constructor(dbPath) {
        this.dbPath = dbPath || join(tmpdir(), `test-${Date.now()}.db`);
    }
    async setup() {
        try {
            // Try to import sqlite3
            const { default: sqlite3 } = await import('sqlite3');
            this.db = new sqlite3.Database(this.dbPath);
            // Enable foreign keys
            await this.execute('PRAGMA foreign_keys = ON');
            // Create basic test schema
            await this.createDefaultSchema();
        }
        catch (error) {
            console.warn('SQLite not available, using in-memory fallback');
            this.db = new MemoryDatabase();
        }
    }
    async cleanup() {
        if (this.db) {
            await this.db.close?.();
            this.db = null;
        }
        try {
            await fs.unlink(this.dbPath);
        }
        catch (error) {
            // File might not exist
        }
    }
    async seed(data) {
        const tableName = 'test_data';
        await this.insertTestData(tableName, data);
    }
    async reset() {
        if (!this.db)
            return;
        // Get all table names
        const tables = await this.query("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
        // Truncate all tables
        for (const table of tables) {
            await this.truncateTable(table.name);
        }
    }
    getConnection() {
        const self = this;
        return {
            async query(sql, params = []) {
                return self.query(sql, params);
            },
            async execute(sql, params = []) {
                return self.execute(sql, params);
            },
            async transaction(callback) {
                await self.execute('BEGIN TRANSACTION');
                try {
                    const result = await callback(this);
                    await self.execute('COMMIT');
                    return result;
                }
                catch (error) {
                    await self.execute('ROLLBACK');
                    throw error;
                }
            },
            async close() {
                return self.cleanup();
            }
        };
    }
    async createSchema(schema) {
        const statements = schema.split(';').filter(stmt => stmt.trim());
        for (const statement of statements) {
            if (statement.trim()) {
                await this.execute(statement);
            }
        }
    }
    async insertTestData(table, data) {
        if (data.length === 0)
            return;
        const columns = Object.keys(data[0]);
        const placeholders = columns.map(() => '?').join(', ');
        const sql = `INSERT INTO ${table} (${columns.join(', ')}) VALUES (${placeholders})`;
        for (const row of data) {
            const values = columns.map(col => row[col]);
            await this.execute(sql, values);
        }
    }
    async truncateTable(table) {
        await this.execute(`DELETE FROM ${table}`);
        await this.execute(`DELETE FROM sqlite_sequence WHERE name='${table}'`);
    }
    async runMigrations(migrations) {
        // Create migrations table if it doesn't exist
        await this.execute(`
      CREATE TABLE IF NOT EXISTS migrations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT UNIQUE NOT NULL,
        executed_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);
        for (const [index, migration] of migrations.entries()) {
            const migrationName = `migration_${index.toString().padStart(3, '0')}`;
            // Check if migration already executed
            const existing = await this.query('SELECT id FROM migrations WHERE name = ?', [migrationName]);
            if (existing.length === 0) {
                await this.execute(migration);
                await this.execute('INSERT INTO migrations (name) VALUES (?)', [migrationName]);
            }
        }
    }
    async query(sql, params = []) {
        if (!this.db)
            throw new Error('Database not initialized');
        return new Promise((resolve, reject) => {
            this.db.all(sql, params, (err, rows) => {
                if (err)
                    reject(err);
                else
                    resolve(rows || []);
            });
        });
    }
    async execute(sql, params = []) {
        if (!this.db)
            throw new Error('Database not initialized');
        return new Promise((resolve, reject) => {
            this.db.run(sql, params, (err) => {
                if (err)
                    reject(err);
                else
                    resolve();
            });
        });
    }
    async createDefaultSchema() {
        const schema = `
      CREATE TABLE IF NOT EXISTS test_data (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        key TEXT UNIQUE NOT NULL,
        value TEXT,
        metadata TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );
      
      CREATE TABLE IF NOT EXISTS test_users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        email TEXT UNIQUE NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );
      
      CREATE TABLE IF NOT EXISTS test_projects (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        type TEXT NOT NULL,
        owner_id INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (owner_id) REFERENCES test_users(id)
      );
      
      CREATE INDEX IF NOT EXISTS idx_test_data_key ON test_data(key);
      CREATE INDEX IF NOT EXISTS idx_test_users_email ON test_users(email);
      CREATE INDEX IF NOT EXISTS idx_test_projects_owner ON test_projects(owner_id);
    `;
        await this.createSchema(schema);
    }
}
export class MemoryDatabaseTestHelper {
    storage = new Map();
    sequences = new Map();
    async setup() {
        this.storage.clear();
        this.sequences.clear();
        this.createDefaultTables();
    }
    async cleanup() {
        this.storage.clear();
        this.sequences.clear();
    }
    async seed(data) {
        await this.insertTestData('test_data', data);
    }
    async reset() {
        this.storage.clear();
        this.sequences.clear();
        this.createDefaultTables();
    }
    getConnection() {
        const self = this;
        return {
            async query(sql, params = []) {
                return self.query(sql, params);
            },
            async execute(sql, params = []) {
                return self.execute(sql, params);
            },
            async transaction(callback) {
                // Memory database doesn't need transactions for testing
                return callback(this);
            },
            async close() {
                return self.cleanup();
            }
        };
    }
    async createSchema(schema) {
        // Parse basic CREATE TABLE statements
        const tableMatches = schema.match(/CREATE TABLE(?:\s+IF NOT EXISTS)?\s+(\w+)/gi);
        if (tableMatches) {
            for (const match of tableMatches) {
                const tableName = match.replace(/CREATE TABLE(?:\s+IF NOT EXISTS)?\s+/i, '');
                if (!this.storage.has(tableName)) {
                    this.storage.set(tableName, new Map());
                    this.sequences.set(tableName, 0);
                }
            }
        }
    }
    async insertTestData(table, data) {
        if (!this.storage.has(table)) {
            this.storage.set(table, new Map());
            this.sequences.set(table, 0);
        }
        const tableData = this.storage.get(table);
        for (const row of data) {
            const id = this.getNextId(table);
            const record = { id, ...row, created_at: new Date().toISOString() };
            tableData.set(id.toString(), record);
        }
    }
    async truncateTable(table) {
        if (this.storage.has(table)) {
            this.storage.get(table).clear();
            this.sequences.set(table, 0);
        }
    }
    async runMigrations(migrations) {
        // Simple migration runner for memory database
        for (const migration of migrations) {
            await this.execute(migration);
        }
    }
    async query(sql, params = []) {
        // Simple SQL parser for memory database
        const upperSql = sql.toUpperCase().trim();
        if (upperSql.startsWith('SELECT')) {
            return this.handleSelect(sql, params);
        }
        return [];
    }
    async execute(sql, params = []) {
        const upperSql = sql.toUpperCase().trim();
        if (upperSql.startsWith('INSERT')) {
            this.handleInsert(sql, params);
        }
        else if (upperSql.startsWith('UPDATE')) {
            this.handleUpdate(sql, params);
        }
        else if (upperSql.startsWith('DELETE')) {
            this.handleDelete(sql, params);
        }
        else if (upperSql.startsWith('CREATE TABLE')) {
            this.handleCreateTable(sql);
        }
    }
    handleSelect(sql, params) {
        // Very basic SELECT implementation
        const tableMatch = sql.match(/FROM\s+(\w+)/i);
        if (!tableMatch)
            return [];
        const tableName = tableMatch[1];
        const tableData = this.storage.get(tableName);
        if (!tableData)
            return [];
        return Array.from(tableData.values());
    }
    handleInsert(sql, params) {
        const tableMatch = sql.match(/INSERT INTO\s+(\w+)/i);
        if (!tableMatch)
            return;
        const tableName = tableMatch[1];
        if (!this.storage.has(tableName)) {
            this.storage.set(tableName, new Map());
            this.sequences.set(tableName, 0);
        }
        const tableData = this.storage.get(tableName);
        const id = this.getNextId(tableName);
        // Simple parameter binding
        const columnsMatch = sql.match(/\(([^)]+)\)/);
        if (columnsMatch) {
            const columns = columnsMatch[1].split(',').map(col => col.trim());
            const record = { id };
            columns.forEach((col, index) => {
                if (params[index] !== undefined) {
                    record[col] = params[index];
                }
            });
            record.created_at = new Date().toISOString();
            tableData.set(id.toString(), record);
        }
    }
    handleUpdate(sql, params) {
        // Basic UPDATE implementation
        const tableMatch = sql.match(/UPDATE\s+(\w+)/i);
        if (!tableMatch)
            return;
        const tableName = tableMatch[1];
        const tableData = this.storage.get(tableName);
        if (!tableData)
            return;
        // For simplicity, update all records
        for (const [key, record] of tableData.entries()) {
            record.updated_at = new Date().toISOString();
            tableData.set(key, record);
        }
    }
    handleDelete(sql, params) {
        const tableMatch = sql.match(/DELETE FROM\s+(\w+)/i);
        if (!tableMatch)
            return;
        const tableName = tableMatch[1];
        const tableData = this.storage.get(tableName);
        if (tableData) {
            tableData.clear();
        }
    }
    handleCreateTable(sql) {
        const tableMatch = sql.match(/CREATE TABLE(?:\s+IF NOT EXISTS)?\s+(\w+)/i);
        if (tableMatch) {
            const tableName = tableMatch[1];
            if (!this.storage.has(tableName)) {
                this.storage.set(tableName, new Map());
                this.sequences.set(tableName, 0);
            }
        }
    }
    createDefaultTables() {
        const tables = ['test_data', 'test_users', 'test_projects'];
        for (const table of tables) {
            this.storage.set(table, new Map());
            this.sequences.set(table, 0);
        }
    }
    getNextId(table) {
        const current = this.sequences.get(table) || 0;
        const next = current + 1;
        this.sequences.set(table, next);
        return next;
    }
}
// Memory database implementation for fallback
class MemoryDatabase {
    helper;
    constructor() {
        this.helper = new MemoryDatabaseTestHelper();
        this.helper.setup();
    }
    all(sql, params, callback) {
        this.helper.getConnection().query(sql, params)
            .then(rows => callback(null, rows))
            .catch(err => callback(err, []));
    }
    run(sql, params, callback) {
        this.helper.getConnection().execute(sql, params)
            .then(() => callback(null))
            .catch(err => callback(err));
    }
    async close() {
        await this.helper.cleanup();
    }
}
// Factory functions
export function createSQLiteTestHelper(dbPath) {
    return new SQLiteDatabaseTestHelper(dbPath);
}
export function createMemoryTestHelper() {
    return new MemoryDatabaseTestHelper();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWh1Z28vY29kZS9jbGF1ZGUtY29kZS1mbG93L3NyYy9fX3Rlc3RzX18vaGVscGVycy9kYXRhYmFzZS10ZXN0LWhlbHBlci50cyIsIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFFBQVEsSUFBSSxFQUFFLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDcEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1QixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBcUI1QixNQUFNLE9BQU8sd0JBQXdCO0lBQzNCLE1BQU0sQ0FBUztJQUNmLEVBQUUsR0FBUSxJQUFJLENBQUM7SUFFdkIsWUFBWSxNQUFlO1FBQ3pCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxRQUFRLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbEUsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsSUFBSSxDQUFDO1lBQ0gsd0JBQXdCO1lBQ3hCLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsTUFBTSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFckQsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRTVDLHNCQUFzQjtZQUN0QixNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsMEJBQTBCLENBQUMsQ0FBQztZQUUvQywyQkFBMkI7WUFDM0IsTUFBTSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUNuQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0RBQWdELENBQUMsQ0FBQztZQUMvRCxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksY0FBYyxFQUFFLENBQUM7UUFDakMsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFL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SUFFRCxHQUFHLENBQUMsR0FBVyxFQUFFLE1BQWEsRUFBRSxRQUE0QjtRQUMxRCxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDO2FBQzdDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDMUIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzlCLENBQUM7Q0FDRjtBQUVELG9CQUFvQjtBQUNwQixNQUFNLFVBQVUsc0JBQXNCLENBQUMsTUFBZTtJQUNwRCxPQUFPLElBQUksd0JBQXdCLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDOUMsQ0FBQztBQUVELE1BQU0sVUFBVSxzQkFBc0I7SUFDcEMsT0FBTyxJQUFJLHdCQUF3QixFQUFFLENBQUM7QUFDeEMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9taHVnby9jb2RlL2NsYXVkZS1jb2RlLWZsb3cvc3JjL19fdGVzdHNfXy9oZWxwZXJzL2RhdGFiYXNlLXRlc3QtaGVscGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRGF0YWJhc2UgVGVzdCBIZWxwZXIgLSBEYXRhYmFzZSBUZXN0aW5nIFV0aWxpdGllc1xuICogXG4gKiBDb21wcmVoZW5zaXZlIGRhdGFiYXNlIHRlc3Rpbmcgc3VwcG9ydCBmb3IgaW50ZWdyYXRpb24gdGVzdHNcbiAqL1xuXG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IHRtcGRpciB9IGZyb20gJ29zJztcblxuZXhwb3J0IGludGVyZmFjZSBEYXRhYmFzZUNvbm5lY3Rpb24ge1xuICBxdWVyeShzcWw6IHN0cmluZywgcGFyYW1zPzogYW55W10pOiBQcm9taXNlPGFueT47XG4gIGV4ZWN1dGUoc3FsOiBzdHJpbmcsIHBhcmFtcz86IGFueVtdKTogUHJvbWlzZTx2b2lkPjtcbiAgdHJhbnNhY3Rpb248VD4oY2FsbGJhY2s6ICh0eDogRGF0YWJhc2VDb25uZWN0aW9uKSA9PiBQcm9taXNlPFQ+KTogUHJvbWlzZTxUPjtcbiAgY2xvc2UoKTogUHJvbWlzZTx2b2lkPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEYXRhYmFzZVRlc3RIZWxwZXIge1xuICBzZXR1cCgpOiBQcm9taXNlPHZvaWQ+O1xuICBjbGVhbnVwKCk6IFByb21pc2U8dm9pZD47XG4gIHNlZWQoZGF0YTogYW55W10pOiBQcm9taXNlPHZvaWQ+O1xuICByZXNldCgpOiBQcm9taXNlPHZvaWQ+O1xuICBnZXRDb25uZWN0aW9uKCk6IERhdGFiYXNlQ29ubmVjdGlvbjtcbiAgY3JlYXRlU2NoZW1hKHNjaGVtYTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPjtcbiAgaW5zZXJ0VGVzdERhdGEodGFibGU6IHN0cmluZywgZGF0YTogYW55W10pOiBQcm9taXNlPHZvaWQ+O1xuICB0cnVuY2F0ZVRhYmxlKHRhYmxlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+O1xuICBydW5NaWdyYXRpb25zKG1pZ3JhdGlvbnM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPjtcbn1cblxuZXhwb3J0IGNsYXNzIFNRTGl0ZURhdGFiYXNlVGVzdEhlbHBlciBpbXBsZW1lbnRzIERhdGFiYXNlVGVzdEhlbHBlciB7XG4gIHByaXZhdGUgZGJQYXRoOiBzdHJpbmc7XG4gIHByaXZhdGUgZGI6IGFueSA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IoZGJQYXRoPzogc3RyaW5nKSB7XG4gICAgdGhpcy5kYlBhdGggPSBkYlBhdGggfHwgam9pbih0bXBkaXIoKSwgYHRlc3QtJHtEYXRlLm5vdygpfS5kYmApO1xuICB9XG5cbiAgYXN5bmMgc2V0dXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFRyeSB0byBpbXBvcnQgc3FsaXRlM1xuICAgICAgY29uc3QgeyBkZWZhdWx0OiBzcWxpdGUzIH0gPSBhd2FpdCBpbXBvcnQoJ3NxbGl0ZTMnKTtcbiAgICAgIFxuICAgICAgdGhpcy5kYiA9IG5ldyBzcWxpdGUzLkRhdGFiYXNlKHRoaXMuZGJQYXRoKTtcbiAgICAgIFxuICAgICAgLy8gRW5hYmxlIGZvcmVpZ24ga2V5c1xuICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKCdQUkFHTUEgZm9yZWlnbl9rZXlzID0gT04nKTtcbiAgICAgIFxuICAgICAgLy8gQ3JlYXRlIGJhc2ljIHRlc3Qgc2NoZW1hXG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZURlZmF1bHRTY2hlbWEoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKCdTUUxpdGUgbm90IGF2YWlsYWJsZSwgdXNpbmcgaW4tbWVtb3J5IGZhbGxiYWNrJyk7XG4gICAgICB0aGlzLmRiID0gbmV3IE1lbW9yeURhdGFiYXNlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2xlYW51cCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5kYikge1xuICAgICAgYXdhaXQgdGhpcy5kYi5jbG9zZT8uKCk7XG4gICAgICB0aGlzLmRiID0gbnVsbDtcbiAgICB9XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZzLnVubGluayh0aGlzLmRiUGF0aCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIEZpbGUgbWlnaHQgbm90IGV4aXN0XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VlZChkYXRhOiBhbnlbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHRhYmxlTmFtZSA9ICd0ZXN0X2RhdGEnO1xuICAgIGF3YWl0IHRoaXMuaW5zZXJ0VGVzdERhdGEodGFibGVOYW1lLCBkYXRhKTtcbiAgfVxuXG4gIGFzeW5jIHJlc2V0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5kYikgcmV0dXJuO1xuICAgIFxuICAgIC8vIEdldCBhbGwgdGFibGUgbmFtZXNcbiAgICBjb25zdCB0YWJsZXMgPSBhd2FpdCB0aGlzLnF1ZXJ5KFxuICAgICAgXCJTRUxFQ1QgbmFtZSBGUk9NIHNxbGl0ZV9tYXN0ZXIgV0hFUkUgdHlwZT0ndGFibGUnIEFORCBuYW1lIE5PVCBMSUtFICdzcWxpdGVfJSdcIlxuICAgICk7XG4gICAgXG4gICAgLy8gVHJ1bmNhdGUgYWxsIHRhYmxlc1xuICAgIGZvciAoY29uc3QgdGFibGUgb2YgdGFibGVzKSB7XG4gICAgICBhd2FpdCB0aGlzLnRydW5jYXRlVGFibGUodGFibGUubmFtZSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0Q29ubmVjdGlvbigpOiBEYXRhYmFzZUNvbm5lY3Rpb24ge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBhc3luYyBxdWVyeShzcWw6IHN0cmluZywgcGFyYW1zOiBhbnlbXSA9IFtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHNlbGYucXVlcnkoc3FsLCBwYXJhbXMpO1xuICAgICAgfSxcbiAgICAgIFxuICAgICAgYXN5bmMgZXhlY3V0ZShzcWw6IHN0cmluZywgcGFyYW1zOiBhbnlbXSA9IFtdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBzZWxmLmV4ZWN1dGUoc3FsLCBwYXJhbXMpO1xuICAgICAgfSxcbiAgICAgIFxuICAgICAgYXN5bmMgdHJhbnNhY3Rpb248VD4oY2FsbGJhY2s6ICh0eDogRGF0YWJhc2VDb25uZWN0aW9uKSA9PiBQcm9taXNlPFQ+KTogUHJvbWlzZTxUPiB7XG4gICAgICAgIGF3YWl0IHNlbGYuZXhlY3V0ZSgnQkVHSU4gVFJBTlNBQ1RJT04nKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYWxsYmFjayh0aGlzKTtcbiAgICAgICAgICBhd2FpdCBzZWxmLmV4ZWN1dGUoJ0NPTU1JVCcpO1xuICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgYXdhaXQgc2VsZi5leGVjdXRlKCdST0xMQkFDSycpO1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgXG4gICAgICBhc3luYyBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHNlbGYuY2xlYW51cCgpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBhc3luYyBjcmVhdGVTY2hlbWEoc2NoZW1hOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzdGF0ZW1lbnRzID0gc2NoZW1hLnNwbGl0KCc7JykuZmlsdGVyKHN0bXQgPT4gc3RtdC50cmltKCkpO1xuICAgIFxuICAgIGZvciAoY29uc3Qgc3RhdGVtZW50IG9mIHN0YXRlbWVudHMpIHtcbiAgICAgIGlmIChzdGF0ZW1lbnQudHJpbSgpKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShzdGF0ZW1lbnQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc2VydFRlc3REYXRhKHRhYmxlOiBzdHJpbmcsIGRhdGE6IGFueVtdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgXG4gICAgY29uc3QgY29sdW1ucyA9IE9iamVjdC5rZXlzKGRhdGFbMF0pO1xuICAgIGNvbnN0IHBsYWNlaG9sZGVycyA9IGNvbHVtbnMubWFwKCgpID0+ICc/Jykuam9pbignLCAnKTtcbiAgICBjb25zdCBzcWwgPSBgSU5TRVJUIElOVE8gJHt0YWJsZX0gKCR7Y29sdW1ucy5qb2luKCcsICcpfSkgVkFMVUVTICgke3BsYWNlaG9sZGVyc30pYDtcbiAgICBcbiAgICBmb3IgKGNvbnN0IHJvdyBvZiBkYXRhKSB7XG4gICAgICBjb25zdCB2YWx1ZXMgPSBjb2x1bW5zLm1hcChjb2wgPT4gcm93W2NvbF0pO1xuICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKHNxbCwgdmFsdWVzKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB0cnVuY2F0ZVRhYmxlKHRhYmxlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGUoYERFTEVURSBGUk9NICR7dGFibGV9YCk7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlKGBERUxFVEUgRlJPTSBzcWxpdGVfc2VxdWVuY2UgV0hFUkUgbmFtZT0nJHt0YWJsZX0nYCk7XG4gIH1cblxuICBhc3luYyBydW5NaWdyYXRpb25zKG1pZ3JhdGlvbnM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gQ3JlYXRlIG1pZ3JhdGlvbnMgdGFibGUgaWYgaXQgZG9lc24ndCBleGlzdFxuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShgXG4gICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBtaWdyYXRpb25zIChcbiAgICAgICAgaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULFxuICAgICAgICBuYW1lIFRFWFQgVU5JUVVFIE5PVCBOVUxMLFxuICAgICAgICBleGVjdXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QXG4gICAgICApXG4gICAgYCk7XG4gICAgXG4gICAgZm9yIChjb25zdCBbaW5kZXgsIG1pZ3JhdGlvbl0gb2YgbWlncmF0aW9ucy5lbnRyaWVzKCkpIHtcbiAgICAgIGNvbnN0IG1pZ3JhdGlvbk5hbWUgPSBgbWlncmF0aW9uXyR7aW5kZXgudG9TdHJpbmcoKS5wYWRTdGFydCgzLCAnMCcpfWA7XG4gICAgICBcbiAgICAgIC8vIENoZWNrIGlmIG1pZ3JhdGlvbiBhbHJlYWR5IGV4ZWN1dGVkXG4gICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMucXVlcnkoXG4gICAgICAgICdTRUxFQ1QgaWQgRlJPTSBtaWdyYXRpb25zIFdIRVJFIG5hbWUgPSA/JyxcbiAgICAgICAgW21pZ3JhdGlvbk5hbWVdXG4gICAgICApO1xuICAgICAgXG4gICAgICBpZiAoZXhpc3RpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShtaWdyYXRpb24pO1xuICAgICAgICBhd2FpdCB0aGlzLmV4ZWN1dGUoXG4gICAgICAgICAgJ0lOU0VSVCBJTlRPIG1pZ3JhdGlvbnMgKG5hbWUpIFZBTFVFUyAoPyknLFxuICAgICAgICAgIFttaWdyYXRpb25OYW1lXVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcXVlcnkoc3FsOiBzdHJpbmcsIHBhcmFtczogYW55W10gPSBbXSk6IFByb21pc2U8YW55W10+IHtcbiAgICBpZiAoIXRoaXMuZGIpIHRocm93IG5ldyBFcnJvcignRGF0YWJhc2Ugbm90IGluaXRpYWxpemVkJyk7XG4gICAgXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuZGIuYWxsKHNxbCwgcGFyYW1zLCAoZXJyOiBhbnksIHJvd3M6IGFueVtdKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpO1xuICAgICAgICBlbHNlIHJlc29sdmUocm93cyB8fCBbXSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZXhlY3V0ZShzcWw6IHN0cmluZywgcGFyYW1zOiBhbnlbXSA9IFtdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmRiKSB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFiYXNlIG5vdCBpbml0aWFsaXplZCcpO1xuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmRiLnJ1bihzcWwsIHBhcmFtcywgKGVycjogYW55KSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpO1xuICAgICAgICBlbHNlIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVEZWZhdWx0U2NoZW1hKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHNjaGVtYSA9IGBcbiAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHRlc3RfZGF0YSAoXG4gICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVkgQVVUT0lOQ1JFTUVOVCxcbiAgICAgICAga2V5IFRFWFQgVU5JUVVFIE5PVCBOVUxMLFxuICAgICAgICB2YWx1ZSBURVhULFxuICAgICAgICBtZXRhZGF0YSBURVhULFxuICAgICAgICBjcmVhdGVkX2F0IERBVEVUSU1FIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsXG4gICAgICAgIHVwZGF0ZWRfYXQgREFURVRJTUUgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUFxuICAgICAgKTtcbiAgICAgIFxuICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgdGVzdF91c2VycyAoXG4gICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVkgQVVUT0lOQ1JFTUVOVCxcbiAgICAgICAgbmFtZSBURVhUIE5PVCBOVUxMLFxuICAgICAgICBlbWFpbCBURVhUIFVOSVFVRSBOT1QgTlVMTCxcbiAgICAgICAgY3JlYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QXG4gICAgICApO1xuICAgICAgXG4gICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyB0ZXN0X3Byb2plY3RzIChcbiAgICAgICAgaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULFxuICAgICAgICBuYW1lIFRFWFQgTk9UIE5VTEwsXG4gICAgICAgIHR5cGUgVEVYVCBOT1QgTlVMTCxcbiAgICAgICAgb3duZXJfaWQgSU5URUdFUixcbiAgICAgICAgY3JlYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QLFxuICAgICAgICBGT1JFSUdOIEtFWSAob3duZXJfaWQpIFJFRkVSRU5DRVMgdGVzdF91c2VycyhpZClcbiAgICAgICk7XG4gICAgICBcbiAgICAgIENSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF90ZXN0X2RhdGFfa2V5IE9OIHRlc3RfZGF0YShrZXkpO1xuICAgICAgQ1JFQVRFIElOREVYIElGIE5PVCBFWElTVFMgaWR4X3Rlc3RfdXNlcnNfZW1haWwgT04gdGVzdF91c2VycyhlbWFpbCk7XG4gICAgICBDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfdGVzdF9wcm9qZWN0c19vd25lciBPTiB0ZXN0X3Byb2plY3RzKG93bmVyX2lkKTtcbiAgICBgO1xuICAgIFxuICAgIGF3YWl0IHRoaXMuY3JlYXRlU2NoZW1hKHNjaGVtYSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE1lbW9yeURhdGFiYXNlVGVzdEhlbHBlciBpbXBsZW1lbnRzIERhdGFiYXNlVGVzdEhlbHBlciB7XG4gIHByaXZhdGUgc3RvcmFnZSA9IG5ldyBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBhbnk+PigpO1xuICBwcml2YXRlIHNlcXVlbmNlcyA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cbiAgYXN5bmMgc2V0dXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5zdG9yYWdlLmNsZWFyKCk7XG4gICAgdGhpcy5zZXF1ZW5jZXMuY2xlYXIoKTtcbiAgICB0aGlzLmNyZWF0ZURlZmF1bHRUYWJsZXMoKTtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5zdG9yYWdlLmNsZWFyKCk7XG4gICAgdGhpcy5zZXF1ZW5jZXMuY2xlYXIoKTtcbiAgfVxuXG4gIGFzeW5jIHNlZWQoZGF0YTogYW55W10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmluc2VydFRlc3REYXRhKCd0ZXN0X2RhdGEnLCBkYXRhKTtcbiAgfVxuXG4gIGFzeW5jIHJlc2V0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuc3RvcmFnZS5jbGVhcigpO1xuICAgIHRoaXMuc2VxdWVuY2VzLmNsZWFyKCk7XG4gICAgdGhpcy5jcmVhdGVEZWZhdWx0VGFibGVzKCk7XG4gIH1cblxuICBnZXRDb25uZWN0aW9uKCk6IERhdGFiYXNlQ29ubmVjdGlvbiB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgIGFzeW5jIHF1ZXJ5KHNxbDogc3RyaW5nLCBwYXJhbXM6IGFueVtdID0gW10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gc2VsZi5xdWVyeShzcWwsIHBhcmFtcyk7XG4gICAgICB9LFxuICAgICAgXG4gICAgICBhc3luYyBleGVjdXRlKHNxbDogc3RyaW5nLCBwYXJhbXM6IGFueVtdID0gW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHNlbGYuZXhlY3V0ZShzcWwsIHBhcmFtcyk7XG4gICAgICB9LFxuICAgICAgXG4gICAgICBhc3luYyB0cmFuc2FjdGlvbjxUPihjYWxsYmFjazogKHR4OiBEYXRhYmFzZUNvbm5lY3Rpb24pID0+IFByb21pc2U8VD4pOiBQcm9taXNlPFQ+IHtcbiAgICAgICAgLy8gTWVtb3J5IGRhdGFiYXNlIGRvZXNuJ3QgbmVlZCB0cmFuc2FjdGlvbnMgZm9yIHRlc3RpbmdcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHRoaXMpO1xuICAgICAgfSxcbiAgICAgIFxuICAgICAgYXN5bmMgY2xvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBzZWxmLmNsZWFudXAoKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2NoZW1hKHNjaGVtYTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gUGFyc2UgYmFzaWMgQ1JFQVRFIFRBQkxFIHN0YXRlbWVudHNcbiAgICBjb25zdCB0YWJsZU1hdGNoZXMgPSBzY2hlbWEubWF0Y2goL0NSRUFURSBUQUJMRSg/OlxccytJRiBOT1QgRVhJU1RTKT9cXHMrKFxcdyspL2dpKTtcbiAgICBpZiAodGFibGVNYXRjaGVzKSB7XG4gICAgICBmb3IgKGNvbnN0IG1hdGNoIG9mIHRhYmxlTWF0Y2hlcykge1xuICAgICAgICBjb25zdCB0YWJsZU5hbWUgPSBtYXRjaC5yZXBsYWNlKC9DUkVBVEUgVEFCTEUoPzpcXHMrSUYgTk9UIEVYSVNUUyk/XFxzKy9pLCAnJyk7XG4gICAgICAgIGlmICghdGhpcy5zdG9yYWdlLmhhcyh0YWJsZU5hbWUpKSB7XG4gICAgICAgICAgdGhpcy5zdG9yYWdlLnNldCh0YWJsZU5hbWUsIG5ldyBNYXAoKSk7XG4gICAgICAgICAgdGhpcy5zZXF1ZW5jZXMuc2V0KHRhYmxlTmFtZSwgMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnNlcnRUZXN0RGF0YSh0YWJsZTogc3RyaW5nLCBkYXRhOiBhbnlbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5zdG9yYWdlLmhhcyh0YWJsZSkpIHtcbiAgICAgIHRoaXMuc3RvcmFnZS5zZXQodGFibGUsIG5ldyBNYXAoKSk7XG4gICAgICB0aGlzLnNlcXVlbmNlcy5zZXQodGFibGUsIDApO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCB0YWJsZURhdGEgPSB0aGlzLnN0b3JhZ2UuZ2V0KHRhYmxlKSE7XG4gICAgXG4gICAgZm9yIChjb25zdCByb3cgb2YgZGF0YSkge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLmdldE5leHRJZCh0YWJsZSk7XG4gICAgICBjb25zdCByZWNvcmQgPSB7IGlkLCAuLi5yb3csIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9O1xuICAgICAgdGFibGVEYXRhLnNldChpZC50b1N0cmluZygpLCByZWNvcmQpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHRydW5jYXRlVGFibGUodGFibGU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLnN0b3JhZ2UuaGFzKHRhYmxlKSkge1xuICAgICAgdGhpcy5zdG9yYWdlLmdldCh0YWJsZSkhLmNsZWFyKCk7XG4gICAgICB0aGlzLnNlcXVlbmNlcy5zZXQodGFibGUsIDApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJ1bk1pZ3JhdGlvbnMobWlncmF0aW9uczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBTaW1wbGUgbWlncmF0aW9uIHJ1bm5lciBmb3IgbWVtb3J5IGRhdGFiYXNlXG4gICAgZm9yIChjb25zdCBtaWdyYXRpb24gb2YgbWlncmF0aW9ucykge1xuICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKG1pZ3JhdGlvbik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBxdWVyeShzcWw6IHN0cmluZywgcGFyYW1zOiBhbnlbXSA9IFtdKTogUHJvbWlzZTxhbnlbXT4ge1xuICAgIC8vIFNpbXBsZSBTUUwgcGFyc2VyIGZvciBtZW1vcnkgZGF0YWJhc2VcbiAgICBjb25zdCB1cHBlclNxbCA9IHNxbC50b1VwcGVyQ2FzZSgpLnRyaW0oKTtcbiAgICBcbiAgICBpZiAodXBwZXJTcWwuc3RhcnRzV2l0aCgnU0VMRUNUJykpIHtcbiAgICAgIHJldHVybiB0aGlzLmhhbmRsZVNlbGVjdChzcWwsIHBhcmFtcyk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZXhlY3V0ZShzcWw6IHN0cmluZywgcGFyYW1zOiBhbnlbXSA9IFtdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdXBwZXJTcWwgPSBzcWwudG9VcHBlckNhc2UoKS50cmltKCk7XG4gICAgXG4gICAgaWYgKHVwcGVyU3FsLnN0YXJ0c1dpdGgoJ0lOU0VSVCcpKSB7XG4gICAgICB0aGlzLmhhbmRsZUluc2VydChzcWwsIHBhcmFtcyk7XG4gICAgfSBlbHNlIGlmICh1cHBlclNxbC5zdGFydHNXaXRoKCdVUERBVEUnKSkge1xuICAgICAgdGhpcy5oYW5kbGVVcGRhdGUoc3FsLCBwYXJhbXMpO1xuICAgIH0gZWxzZSBpZiAodXBwZXJTcWwuc3RhcnRzV2l0aCgnREVMRVRFJykpIHtcbiAgICAgIHRoaXMuaGFuZGxlRGVsZXRlKHNxbCwgcGFyYW1zKTtcbiAgICB9IGVsc2UgaWYgKHVwcGVyU3FsLnN0YXJ0c1dpdGgoJ0NSRUFURSBUQUJMRScpKSB7XG4gICAgICB0aGlzLmhhbmRsZUNyZWF0ZVRhYmxlKHNxbCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVTZWxlY3Qoc3FsOiBzdHJpbmcsIHBhcmFtczogYW55W10pOiBhbnlbXSB7XG4gICAgLy8gVmVyeSBiYXNpYyBTRUxFQ1QgaW1wbGVtZW50YXRpb25cbiAgICBjb25zdCB0YWJsZU1hdGNoID0gc3FsLm1hdGNoKC9GUk9NXFxzKyhcXHcrKS9pKTtcbiAgICBpZiAoIXRhYmxlTWF0Y2gpIHJldHVybiBbXTtcbiAgICBcbiAgICBjb25zdCB0YWJsZU5hbWUgPSB0YWJsZU1hdGNoWzFdO1xuICAgIGNvbnN0IHRhYmxlRGF0YSA9IHRoaXMuc3RvcmFnZS5nZXQodGFibGVOYW1lKTtcbiAgICBpZiAoIXRhYmxlRGF0YSkgcmV0dXJuIFtdO1xuICAgIFxuICAgIHJldHVybiBBcnJheS5mcm9tKHRhYmxlRGF0YS52YWx1ZXMoKSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUluc2VydChzcWw6IHN0cmluZywgcGFyYW1zOiBhbnlbXSk6IHZvaWQge1xuICAgIGNvbnN0IHRhYmxlTWF0Y2ggPSBzcWwubWF0Y2goL0lOU0VSVCBJTlRPXFxzKyhcXHcrKS9pKTtcbiAgICBpZiAoIXRhYmxlTWF0Y2gpIHJldHVybjtcbiAgICBcbiAgICBjb25zdCB0YWJsZU5hbWUgPSB0YWJsZU1hdGNoWzFdO1xuICAgIGlmICghdGhpcy5zdG9yYWdlLmhhcyh0YWJsZU5hbWUpKSB7XG4gICAgICB0aGlzLnN0b3JhZ2Uuc2V0KHRhYmxlTmFtZSwgbmV3IE1hcCgpKTtcbiAgICAgIHRoaXMuc2VxdWVuY2VzLnNldCh0YWJsZU5hbWUsIDApO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCB0YWJsZURhdGEgPSB0aGlzLnN0b3JhZ2UuZ2V0KHRhYmxlTmFtZSkhO1xuICAgIGNvbnN0IGlkID0gdGhpcy5nZXROZXh0SWQodGFibGVOYW1lKTtcbiAgICBcbiAgICAvLyBTaW1wbGUgcGFyYW1ldGVyIGJpbmRpbmdcbiAgICBjb25zdCBjb2x1bW5zTWF0Y2ggPSBzcWwubWF0Y2goL1xcKChbXildKylcXCkvKTtcbiAgICBpZiAoY29sdW1uc01hdGNoKSB7XG4gICAgICBjb25zdCBjb2x1bW5zID0gY29sdW1uc01hdGNoWzFdLnNwbGl0KCcsJykubWFwKGNvbCA9PiBjb2wudHJpbSgpKTtcbiAgICAgIGNvbnN0IHJlY29yZDogYW55ID0geyBpZCB9O1xuICAgICAgXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbCwgaW5kZXgpID0+IHtcbiAgICAgICAgaWYgKHBhcmFtc1tpbmRleF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJlY29yZFtjb2xdID0gcGFyYW1zW2luZGV4XTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIHJlY29yZC5jcmVhdGVkX2F0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgICAgdGFibGVEYXRhLnNldChpZC50b1N0cmluZygpLCByZWNvcmQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlVXBkYXRlKHNxbDogc3RyaW5nLCBwYXJhbXM6IGFueVtdKTogdm9pZCB7XG4gICAgLy8gQmFzaWMgVVBEQVRFIGltcGxlbWVudGF0aW9uXG4gICAgY29uc3QgdGFibGVNYXRjaCA9IHNxbC5tYXRjaCgvVVBEQVRFXFxzKyhcXHcrKS9pKTtcbiAgICBpZiAoIXRhYmxlTWF0Y2gpIHJldHVybjtcbiAgICBcbiAgICBjb25zdCB0YWJsZU5hbWUgPSB0YWJsZU1hdGNoWzFdO1xuICAgIGNvbnN0IHRhYmxlRGF0YSA9IHRoaXMuc3RvcmFnZS5nZXQodGFibGVOYW1lKTtcbiAgICBpZiAoIXRhYmxlRGF0YSkgcmV0dXJuO1xuICAgIFxuICAgIC8vIEZvciBzaW1wbGljaXR5LCB1cGRhdGUgYWxsIHJlY29yZHNcbiAgICBmb3IgKGNvbnN0IFtrZXksIHJlY29yZF0gb2YgdGFibGVEYXRhLmVudHJpZXMoKSkge1xuICAgICAgcmVjb3JkLnVwZGF0ZWRfYXQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgICB0YWJsZURhdGEuc2V0KGtleSwgcmVjb3JkKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZURlbGV0ZShzcWw6IHN0cmluZywgcGFyYW1zOiBhbnlbXSk6IHZvaWQge1xuICAgIGNvbnN0IHRhYmxlTWF0Y2ggPSBzcWwubWF0Y2goL0RFTEVURSBGUk9NXFxzKyhcXHcrKS9pKTtcbiAgICBpZiAoIXRhYmxlTWF0Y2gpIHJldHVybjtcbiAgICBcbiAgICBjb25zdCB0YWJsZU5hbWUgPSB0YWJsZU1hdGNoWzFdO1xuICAgIGNvbnN0IHRhYmxlRGF0YSA9IHRoaXMuc3RvcmFnZS5nZXQodGFibGVOYW1lKTtcbiAgICBpZiAodGFibGVEYXRhKSB7XG4gICAgICB0YWJsZURhdGEuY2xlYXIoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUNyZWF0ZVRhYmxlKHNxbDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgdGFibGVNYXRjaCA9IHNxbC5tYXRjaCgvQ1JFQVRFIFRBQkxFKD86XFxzK0lGIE5PVCBFWElTVFMpP1xccysoXFx3KykvaSk7XG4gICAgaWYgKHRhYmxlTWF0Y2gpIHtcbiAgICAgIGNvbnN0IHRhYmxlTmFtZSA9IHRhYmxlTWF0Y2hbMV07XG4gICAgICBpZiAoIXRoaXMuc3RvcmFnZS5oYXModGFibGVOYW1lKSkge1xuICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0KHRhYmxlTmFtZSwgbmV3IE1hcCgpKTtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZXMuc2V0KHRhYmxlTmFtZSwgMCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVEZWZhdWx0VGFibGVzKCk6IHZvaWQge1xuICAgIGNvbnN0IHRhYmxlcyA9IFsndGVzdF9kYXRhJywgJ3Rlc3RfdXNlcnMnLCAndGVzdF9wcm9qZWN0cyddO1xuICAgIGZvciAoY29uc3QgdGFibGUgb2YgdGFibGVzKSB7XG4gICAgICB0aGlzLnN0b3JhZ2Uuc2V0KHRhYmxlLCBuZXcgTWFwKCkpO1xuICAgICAgdGhpcy5zZXF1ZW5jZXMuc2V0KHRhYmxlLCAwKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldE5leHRJZCh0YWJsZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5zZXF1ZW5jZXMuZ2V0KHRhYmxlKSB8fCAwO1xuICAgIGNvbnN0IG5leHQgPSBjdXJyZW50ICsgMTtcbiAgICB0aGlzLnNlcXVlbmNlcy5zZXQodGFibGUsIG5leHQpO1xuICAgIHJldHVybiBuZXh0O1xuICB9XG59XG5cbi8vIE1lbW9yeSBkYXRhYmFzZSBpbXBsZW1lbnRhdGlvbiBmb3IgZmFsbGJhY2tcbmNsYXNzIE1lbW9yeURhdGFiYXNlIHtcbiAgcHJpdmF0ZSBoZWxwZXI6IE1lbW9yeURhdGFiYXNlVGVzdEhlbHBlcjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmhlbHBlciA9IG5ldyBNZW1vcnlEYXRhYmFzZVRlc3RIZWxwZXIoKTtcbiAgICB0aGlzLmhlbHBlci5zZXR1cCgpO1xuICB9XG5cbiAgYWxsKHNxbDogc3RyaW5nLCBwYXJhbXM6IGFueVtdLCBjYWxsYmFjazogKGVycjogYW55LCByb3dzOiBhbnlbXSkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMuaGVscGVyLmdldENvbm5lY3Rpb24oKS5xdWVyeShzcWwsIHBhcmFtcylcbiAgICAgIC50aGVuKHJvd3MgPT4gY2FsbGJhY2sobnVsbCwgcm93cykpXG4gICAgICAuY2F0Y2goZXJyID0+IGNhbGxiYWNrKGVyciwgW10pKTtcbiAgfVxuXG4gIHJ1bihzcWw6IHN0cmluZywgcGFyYW1zOiBhbnlbXSwgY2FsbGJhY2s6IChlcnI6IGFueSkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMuaGVscGVyLmdldENvbm5lY3Rpb24oKS5leGVjdXRlKHNxbCwgcGFyYW1zKVxuICAgICAgLnRoZW4oKCkgPT4gY2FsbGJhY2sobnVsbCkpXG4gICAgICAuY2F0Y2goZXJyID0+IGNhbGxiYWNrKGVycikpO1xuICB9XG5cbiAgYXN5bmMgY2xvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5oZWxwZXIuY2xlYW51cCgpO1xuICB9XG59XG5cbi8vIEZhY3RvcnkgZnVuY3Rpb25zXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU1FMaXRlVGVzdEhlbHBlcihkYlBhdGg/OiBzdHJpbmcpOiBEYXRhYmFzZVRlc3RIZWxwZXIge1xuICByZXR1cm4gbmV3IFNRTGl0ZURhdGFiYXNlVGVzdEhlbHBlcihkYlBhdGgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTWVtb3J5VGVzdEhlbHBlcigpOiBEYXRhYmFzZVRlc3RIZWxwZXIge1xuICByZXR1cm4gbmV3IE1lbW9yeURhdGFiYXNlVGVzdEhlbHBlcigpO1xufSJdLCJ2ZXJzaW9uIjozfQ==