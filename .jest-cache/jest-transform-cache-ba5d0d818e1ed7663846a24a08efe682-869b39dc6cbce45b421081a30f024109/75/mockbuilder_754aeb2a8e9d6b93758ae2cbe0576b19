e960b10787273d0cba3e65ef6895525d
/**
 * Mock Builder - London School TDD Support
 *
 * Creates sophisticated mocks for interaction-focused testing
 */
import { jest } from '@jest/globals';
export class MockBuilder {
    static instance;
    globalConfig;
    constructor(config = { strategy: 'hybrid' }) {
        this.globalConfig = config;
    }
    static getInstance(config) {
        if (!MockBuilder.instance) {
            MockBuilder.instance = new MockBuilder(config);
        }
        return MockBuilder.instance;
    }
    /**
     * Create a mock object for a class/interface - London School approach
     */
    create(type, config = this.globalConfig) {
        const mockObj = {};
        const prototype = type.prototype;
        // Get all methods from the prototype
        const methods = this.extractMethods(prototype);
        for (const method of methods) {
            mockObj[method] = this.createMethodMock(method, config);
        }
        // Add interaction tracking for London School
        if (config.trackInteractions) {
            this.addInteractionTracking(mockObj);
        }
        return mockObj;
    }
    /**
     * Create a partial mock with specific overrides
     */
    createPartial(overrides, config = this.globalConfig) {
        const mockObj = {};
        Object.keys(overrides).forEach(key => {
            const value = overrides[key];
            if (typeof value === 'function') {
                mockObj[key] = jest.fn(value);
            }
            else {
                mockObj[key] = value;
            }
        });
        if (config.trackInteractions) {
            this.addInteractionTracking(mockObj);
        }
        return mockObj;
    }
    /**
     * Create spies on an existing object - Hybrid approach
     */
    createSpy(obj, methods) {
        const spy = { ...obj };
        const methodsToSpy = methods || Object.getOwnPropertyNames(Object.getPrototypeOf(obj));
        methodsToSpy.forEach(method => {
            if (typeof obj[method] === 'function') {
                spy[method] = jest.spyOn(obj, method);
            }
        });
        return spy;
    }
    /**
     * Create common dependency mocks for Claude Code Flow
     */
    createCommonMocks() {
        return {
            // Memory Store mock
            memoryStore: this.create(class MemoryStore {
                initialize() { }
                store() { }
                retrieve() { }
                delete() { }
                query() { }
                close() { }
            }),
            // Neural Engine mock
            neuralEngine: this.create(class NeuralEngine {
                initialize() { }
                processInput() { }
                trainModel() { }
                predict() { }
                optimize() { }
            }),
            // Swarm Orchestrator mock
            swarmOrchestrator: this.create(class SwarmOrchestrator {
                initialize() { }
                spawnAgent() { }
                orchestrateTask() { }
                getAgentStatus() { }
                terminateAgent() { }
                getSwarmStatus() { }
            }),
            // MCP Server mock
            mcpServer: this.create(class MCPServer {
                initialize() { }
                handleMessage() { }
                registerTool() { }
                shutdown() { }
            }),
            // Database mock
            database: this.create(class Database {
                connect() { }
                disconnect() { }
                query() { }
                transaction() { }
            }),
            // File System mock
            fileSystem: this.create(class FileSystem {
                readFile() { }
                writeFile() { }
                mkdir() { }
                exists() { }
                stat() { }
            })
        };
    }
    /**
     * Create expectation builders for London School interaction testing
     */
    createExpectations(mock) {
        const expectations = {
            // Verify method was called with specific arguments
            toHaveBeenCalledWith: (method, ...args) => {
                const mockMethod = mock[method];
                expect(mockMethod).toHaveBeenCalledWith(...args);
                return expectations;
            },
            // Verify call order for interaction sequences
            toHaveBeenCalledInOrder: (methods) => {
                const calls = methods.map(method => {
                    const mockMethod = mock[method];
                    return mockMethod.mock.invocationCallOrder[0];
                });
                for (let i = 1; i < calls.length; i++) {
                    expect(calls[i - 1]).toBeLessThan(calls[i]);
                }
                return expectations;
            },
            // Verify interaction patterns
            toHaveInteractionPattern: (pattern) => {
                const interactions = mock.__interactions || [];
                const patternFound = this.matchInteractionPattern(interactions, pattern);
                expect(patternFound).toBe(true);
                return expectations;
            },
            // Verify no unexpected interactions
            toHaveNoUnexpectedInteractions: () => {
                const interactions = mock.__interactions || [];
                const expected = mock.__expectedInteractions || [];
                const unexpected = interactions.filter((i) => !expected.includes(i.method));
                expect(unexpected).toHaveLength(0);
                return expectations;
            }
        };
        return expectations;
    }
    /**
     * Reset all mocks - useful for test isolation
     */
    resetAllMocks(mocks) {
        Object.values(mocks).forEach(mock => {
            if (mock && typeof mock === 'object') {
                Object.values(mock).forEach(method => {
                    if (jest.isMockFunction(method)) {
                        method.mockReset();
                    }
                });
                // Clear interaction tracking
                if (mock.__interactions) {
                    mock.__interactions = [];
                }
            }
        });
    }
    extractMethods(prototype) {
        const methods = [];
        let current = prototype;
        while (current && current !== Object.prototype) {
            Object.getOwnPropertyNames(current).forEach(name => {
                if (name !== 'constructor' && typeof current[name] === 'function') {
                    if (!methods.includes(name)) {
                        methods.push(name);
                    }
                }
            });
            current = Object.getPrototypeOf(current);
        }
        return methods;
    }
    createMethodMock(methodName, config) {
        const mock = jest.fn();
        if (config.autoGenerate) {
            // Auto-generate reasonable return values based on method name
            if (methodName.startsWith('get') || methodName.startsWith('find')) {
                mock.mockResolvedValue({});
            }
            else if (methodName.startsWith('is') || methodName.startsWith('has')) {
                mock.mockReturnValue(true);
            }
            else if (methodName.startsWith('create') || methodName.startsWith('save')) {
                mock.mockResolvedValue({ id: 'generated-id' });
            }
        }
        return mock;
    }
    addInteractionTracking(mockObj) {
        const interactions = [];
        mockObj.__interactions = interactions;
        // Wrap all mock functions to track interactions
        Object.keys(mockObj).forEach(key => {
            const originalMock = mockObj[key];
            if (jest.isMockFunction(originalMock)) {
                mockObj[key] = jest.fn((...args) => {
                    interactions.push({
                        method: key,
                        args,
                        timestamp: Date.now()
                    });
                    return originalMock(...args);
                });
            }
        });
    }
    matchInteractionPattern(interactions, pattern) {
        // Simple pattern matching for interaction sequences
        // Pattern format: "method1 -> method2 -> method3"
        const expectedSequence = pattern.split(' -> ').map(s => s.trim());
        const actualSequence = interactions.map(i => i.method);
        // Check if expected sequence exists in actual sequence
        for (let i = 0; i <= actualSequence.length - expectedSequence.length; i++) {
            let matches = true;
            for (let j = 0; j < expectedSequence.length; j++) {
                if (actualSequence[i + j] !== expectedSequence[j]) {
                    matches = false;
                    break;
                }
            }
            if (matches)
                return true;
        }
        return false;
    }
}
// Convenience functions for common patterns
export const mockBuilder = MockBuilder.getInstance();
export function createLondonMocks(config) {
    const londonConfig = {
        strategy: 'strict',
        trackInteractions: true,
        autoGenerate: true,
        autoReset: true,
        ...config
    };
    return new MockBuilder(londonConfig);
}
export function createClassicalMocks(config) {
    const classicalConfig = {
        strategy: 'minimal',
        trackInteractions: false,
        autoGenerate: false,
        autoReset: false,
        ...config
    };
    return new MockBuilder(classicalConfig);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWh1Z28vY29kZS9jbGF1ZGUtY29kZS1mbG93L3NyYy9fX3Rlc3RzX18vaGVscGVycy9tb2NrLWJ1aWxkZXIudHMiLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHckMsTUFBTSxPQUFPLFdBQVc7SUFDZCxNQUFNLENBQUMsUUFBUSxDQUFjO0lBQzdCLFlBQVksQ0FBb0I7SUFFeEMsWUFBWSxTQUE0QixFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUU7UUFDNUQsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUM7SUFDN0IsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBMEI7UUFDM0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMxQixXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2pELENBQUM7UUFDRCxPQUFPLFdBQVcsQ0FBQyxRQUFRLENBQUM7SUFDOUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUNKLElBQStCLEVBQy9CLFNBQTRCLElBQUksQ0FBQyxZQUFZO1FBRTdDLE1BQU0sT0FBTyxHQUFlLEVBQUUsQ0FBQztRQUMvQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBRWpDLHFDQUFxQztRQUNyQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRS9DLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFLENBQUM7WUFDN0IsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDMUQsQ0FBQztRQUVELDZDQUE2QztRQUM3QyxJQUFJLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQzdCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FB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QUFFLE9BQU8sSUFBSSxDQUFDO1FBQzNCLENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FDRjtBQUVELDRDQUE0QztBQUM1QyxNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBRXJELE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxNQUFtQztJQUNuRSxNQUFNLFlBQVksR0FBc0I7UUFDdEMsUUFBUSxFQUFFLFFBQVE7UUFDbEIsaUJBQWlCLEVBQUUsSUFBSTtRQUN2QixZQUFZLEVBQUUsSUFBSTtRQUNsQixTQUFTLEVBQUUsSUFBSTtRQUNmLEdBQUcsTUFBTTtLQUNWLENBQUM7SUFFRixPQUFPLElBQUksV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxNQUFNLFVBQVUsb0JBQW9CLENBQUMsTUFBbUM7SUFDdEUsTUFBTSxlQUFlLEdBQXNCO1FBQ3pDLFFBQVEsRUFBRSxTQUFTO1FBQ25CLGlCQUFpQixFQUFFLEtBQUs7UUFDeEIsWUFBWSxFQUFFLEtBQUs7UUFDbkIsU0FBUyxFQUFFLEtBQUs7UUFDaEIsR0FBRyxNQUFNO0tBQ1YsQ0FBQztJQUVGLE9BQU8sSUFBSSxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDMUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9taHVnby9jb2RlL2NsYXVkZS1jb2RlLWZsb3cvc3JjL19fdGVzdHNfXy9oZWxwZXJzL21vY2stYnVpbGRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIE1vY2sgQnVpbGRlciAtIExvbmRvbiBTY2hvb2wgVEREIFN1cHBvcnRcbiAqIFxuICogQ3JlYXRlcyBzb3BoaXN0aWNhdGVkIG1vY2tzIGZvciBpbnRlcmFjdGlvbi1mb2N1c2VkIHRlc3RpbmdcbiAqL1xuXG5pbXBvcnQgeyBqZXN0IH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5pbXBvcnQgdHlwZSB7IE1vY2tDb25maWd1cmF0aW9uLCBNb2NrT2JqZWN0IH0gZnJvbSAnLi90eXBlcy5qcyc7XG5cbmV4cG9ydCBjbGFzcyBNb2NrQnVpbGRlciB7XG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBNb2NrQnVpbGRlcjtcbiAgcHJpdmF0ZSBnbG9iYWxDb25maWc6IE1vY2tDb25maWd1cmF0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogTW9ja0NvbmZpZ3VyYXRpb24gPSB7IHN0cmF0ZWd5OiAnaHlicmlkJyB9KSB7XG4gICAgdGhpcy5nbG9iYWxDb25maWcgPSBjb25maWc7XG4gIH1cblxuICBzdGF0aWMgZ2V0SW5zdGFuY2UoY29uZmlnPzogTW9ja0NvbmZpZ3VyYXRpb24pOiBNb2NrQnVpbGRlciB7XG4gICAgaWYgKCFNb2NrQnVpbGRlci5pbnN0YW5jZSkge1xuICAgICAgTW9ja0J1aWxkZXIuaW5zdGFuY2UgPSBuZXcgTW9ja0J1aWxkZXIoY29uZmlnKTtcbiAgICB9XG4gICAgcmV0dXJuIE1vY2tCdWlsZGVyLmluc3RhbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG1vY2sgb2JqZWN0IGZvciBhIGNsYXNzL2ludGVyZmFjZSAtIExvbmRvbiBTY2hvb2wgYXBwcm9hY2hcbiAgICovXG4gIGNyZWF0ZTxUPihcbiAgICB0eXBlOiBuZXcgKC4uLmFyZ3M6IGFueVtdKSA9PiBULCBcbiAgICBjb25maWc6IE1vY2tDb25maWd1cmF0aW9uID0gdGhpcy5nbG9iYWxDb25maWdcbiAgKTogVCB7XG4gICAgY29uc3QgbW9ja09iajogTW9ja09iamVjdCA9IHt9O1xuICAgIGNvbnN0IHByb3RvdHlwZSA9IHR5cGUucHJvdG90eXBlO1xuICAgIFxuICAgIC8vIEdldCBhbGwgbWV0aG9kcyBmcm9tIHRoZSBwcm90b3R5cGVcbiAgICBjb25zdCBtZXRob2RzID0gdGhpcy5leHRyYWN0TWV0aG9kcyhwcm90b3R5cGUpO1xuICAgIFxuICAgIGZvciAoY29uc3QgbWV0aG9kIG9mIG1ldGhvZHMpIHtcbiAgICAgIG1vY2tPYmpbbWV0aG9kXSA9IHRoaXMuY3JlYXRlTWV0aG9kTW9jayhtZXRob2QsIGNvbmZpZyk7XG4gICAgfVxuXG4gICAgLy8gQWRkIGludGVyYWN0aW9uIHRyYWNraW5nIGZvciBMb25kb24gU2Nob29sXG4gICAgaWYgKGNvbmZpZy50cmFja0ludGVyYWN0aW9ucykge1xuICAgICAgdGhpcy5hZGRJbnRlcmFjdGlvblRyYWNraW5nKG1vY2tPYmopO1xuICAgIH1cblxuICAgIHJldHVybiBtb2NrT2JqIGFzIFQ7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgcGFydGlhbCBtb2NrIHdpdGggc3BlY2lmaWMgb3ZlcnJpZGVzXG4gICAqL1xuICBjcmVhdGVQYXJ0aWFsPFQ+KG92ZXJyaWRlczogUGFydGlhbDxUPiwgY29uZmlnOiBNb2NrQ29uZmlndXJhdGlvbiA9IHRoaXMuZ2xvYmFsQ29uZmlnKTogVCB7XG4gICAgY29uc3QgbW9ja09iajogTW9ja09iamVjdCA9IHt9O1xuICAgIFxuICAgIE9iamVjdC5rZXlzKG92ZXJyaWRlcykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBvdmVycmlkZXNba2V5IGFzIGtleW9mIFRdO1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBtb2NrT2JqW2tleV0gPSBqZXN0LmZuKHZhbHVlIGFzIGFueSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtb2NrT2JqW2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChjb25maWcudHJhY2tJbnRlcmFjdGlvbnMpIHtcbiAgICAgIHRoaXMuYWRkSW50ZXJhY3Rpb25UcmFja2luZyhtb2NrT2JqKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbW9ja09iaiBhcyBUO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBzcGllcyBvbiBhbiBleGlzdGluZyBvYmplY3QgLSBIeWJyaWQgYXBwcm9hY2hcbiAgICovXG4gIGNyZWF0ZVNweTxUIGV4dGVuZHMgb2JqZWN0PihvYmo6IFQsIG1ldGhvZHM/OiAoa2V5b2YgVClbXSk6IFQge1xuICAgIGNvbnN0IHNweSA9IHsgLi4ub2JqIH07XG4gICAgY29uc3QgbWV0aG9kc1RvU3B5ID0gbWV0aG9kcyB8fCBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSk7XG4gICAgXG4gICAgbWV0aG9kc1RvU3B5LmZvckVhY2gobWV0aG9kID0+IHtcbiAgICAgIGlmICh0eXBlb2Ygb2JqW21ldGhvZF0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgc3B5W21ldGhvZF0gPSBqZXN0LnNweU9uKG9iaiwgbWV0aG9kIGFzIGFueSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gc3B5O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBjb21tb24gZGVwZW5kZW5jeSBtb2NrcyBmb3IgQ2xhdWRlIENvZGUgRmxvd1xuICAgKi9cbiAgY3JlYXRlQ29tbW9uTW9ja3MoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC8vIE1lbW9yeSBTdG9yZSBtb2NrXG4gICAgICBtZW1vcnlTdG9yZTogdGhpcy5jcmVhdGUoY2xhc3MgTWVtb3J5U3RvcmUge1xuICAgICAgICBpbml0aWFsaXplKCkge31cbiAgICAgICAgc3RvcmUoKSB7fVxuICAgICAgICByZXRyaWV2ZSgpIHt9XG4gICAgICAgIGRlbGV0ZSgpIHt9XG4gICAgICAgIHF1ZXJ5KCkge31cbiAgICAgICAgY2xvc2UoKSB7fVxuICAgICAgfSksXG5cbiAgICAgIC8vIE5ldXJhbCBFbmdpbmUgbW9ja1xuICAgICAgbmV1cmFsRW5naW5lOiB0aGlzLmNyZWF0ZShjbGFzcyBOZXVyYWxFbmdpbmUge1xuICAgICAgICBpbml0aWFsaXplKCkge31cbiAgICAgICAgcHJvY2Vzc0lucHV0KCkge31cbiAgICAgICAgdHJhaW5Nb2RlbCgpIHt9XG4gICAgICAgIHByZWRpY3QoKSB7fVxuICAgICAgICBvcHRpbWl6ZSgpIHt9XG4gICAgICB9KSxcblxuICAgICAgLy8gU3dhcm0gT3JjaGVzdHJhdG9yIG1vY2tcbiAgICAgIHN3YXJtT3JjaGVzdHJhdG9yOiB0aGlzLmNyZWF0ZShjbGFzcyBTd2FybU9yY2hlc3RyYXRvciB7XG4gICAgICAgIGluaXRpYWxpemUoKSB7fVxuICAgICAgICBzcGF3bkFnZW50KCkge31cbiAgICAgICAgb3JjaGVzdHJhdGVUYXNrKCkge31cbiAgICAgICAgZ2V0QWdlbnRTdGF0dXMoKSB7fVxuICAgICAgICB0ZXJtaW5hdGVBZ2VudCgpIHt9XG4gICAgICAgIGdldFN3YXJtU3RhdHVzKCkge31cbiAgICAgIH0pLFxuXG4gICAgICAvLyBNQ1AgU2VydmVyIG1vY2tcbiAgICAgIG1jcFNlcnZlcjogdGhpcy5jcmVhdGUoY2xhc3MgTUNQU2VydmVyIHtcbiAgICAgICAgaW5pdGlhbGl6ZSgpIHt9XG4gICAgICAgIGhhbmRsZU1lc3NhZ2UoKSB7fVxuICAgICAgICByZWdpc3RlclRvb2woKSB7fVxuICAgICAgICBzaHV0ZG93bigpIHt9XG4gICAgICB9KSxcblxuICAgICAgLy8gRGF0YWJhc2UgbW9ja1xuICAgICAgZGF0YWJhc2U6IHRoaXMuY3JlYXRlKGNsYXNzIERhdGFiYXNlIHtcbiAgICAgICAgY29ubmVjdCgpIHt9XG4gICAgICAgIGRpc2Nvbm5lY3QoKSB7fVxuICAgICAgICBxdWVyeSgpIHt9XG4gICAgICAgIHRyYW5zYWN0aW9uKCkge31cbiAgICAgIH0pLFxuXG4gICAgICAvLyBGaWxlIFN5c3RlbSBtb2NrXG4gICAgICBmaWxlU3lzdGVtOiB0aGlzLmNyZWF0ZShjbGFzcyBGaWxlU3lzdGVtIHtcbiAgICAgICAgcmVhZEZpbGUoKSB7fVxuICAgICAgICB3cml0ZUZpbGUoKSB7fVxuICAgICAgICBta2RpcigpIHt9XG4gICAgICAgIGV4aXN0cygpIHt9XG4gICAgICAgIHN0YXQoKSB7fVxuICAgICAgfSlcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBleHBlY3RhdGlvbiBidWlsZGVycyBmb3IgTG9uZG9uIFNjaG9vbCBpbnRlcmFjdGlvbiB0ZXN0aW5nXG4gICAqL1xuICBjcmVhdGVFeHBlY3RhdGlvbnM8VD4obW9jazogVCkge1xuICAgIGNvbnN0IGV4cGVjdGF0aW9ucyA9IHtcbiAgICAgIC8vIFZlcmlmeSBtZXRob2Qgd2FzIGNhbGxlZCB3aXRoIHNwZWNpZmljIGFyZ3VtZW50c1xuICAgICAgdG9IYXZlQmVlbkNhbGxlZFdpdGg6IChtZXRob2Q6IGtleW9mIFQsIC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gICAgICAgIGNvbnN0IG1vY2tNZXRob2QgPSAobW9jayBhcyBhbnkpW21ldGhvZF07XG4gICAgICAgIGV4cGVjdChtb2NrTWV0aG9kKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCguLi5hcmdzKTtcbiAgICAgICAgcmV0dXJuIGV4cGVjdGF0aW9ucztcbiAgICAgIH0sXG5cbiAgICAgIC8vIFZlcmlmeSBjYWxsIG9yZGVyIGZvciBpbnRlcmFjdGlvbiBzZXF1ZW5jZXNcbiAgICAgIHRvSGF2ZUJlZW5DYWxsZWRJbk9yZGVyOiAobWV0aG9kczogKGtleW9mIFQpW10pID0+IHtcbiAgICAgICAgY29uc3QgY2FsbHMgPSBtZXRob2RzLm1hcChtZXRob2QgPT4ge1xuICAgICAgICAgIGNvbnN0IG1vY2tNZXRob2QgPSAobW9jayBhcyBhbnkpW21ldGhvZF07XG4gICAgICAgICAgcmV0dXJuIG1vY2tNZXRob2QubW9jay5pbnZvY2F0aW9uQ2FsbE9yZGVyWzBdO1xuICAgICAgICB9KTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNhbGxzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgZXhwZWN0KGNhbGxzW2kgLSAxXSkudG9CZUxlc3NUaGFuKGNhbGxzW2ldKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZXhwZWN0YXRpb25zO1xuICAgICAgfSxcblxuICAgICAgLy8gVmVyaWZ5IGludGVyYWN0aW9uIHBhdHRlcm5zXG4gICAgICB0b0hhdmVJbnRlcmFjdGlvblBhdHRlcm46IChwYXR0ZXJuOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgaW50ZXJhY3Rpb25zID0gKG1vY2sgYXMgYW55KS5fX2ludGVyYWN0aW9ucyB8fCBbXTtcbiAgICAgICAgY29uc3QgcGF0dGVybkZvdW5kID0gdGhpcy5tYXRjaEludGVyYWN0aW9uUGF0dGVybihpbnRlcmFjdGlvbnMsIHBhdHRlcm4pO1xuICAgICAgICBleHBlY3QocGF0dGVybkZvdW5kKS50b0JlKHRydWUpO1xuICAgICAgICByZXR1cm4gZXhwZWN0YXRpb25zO1xuICAgICAgfSxcblxuICAgICAgLy8gVmVyaWZ5IG5vIHVuZXhwZWN0ZWQgaW50ZXJhY3Rpb25zXG4gICAgICB0b0hhdmVOb1VuZXhwZWN0ZWRJbnRlcmFjdGlvbnM6ICgpID0+IHtcbiAgICAgICAgY29uc3QgaW50ZXJhY3Rpb25zID0gKG1vY2sgYXMgYW55KS5fX2ludGVyYWN0aW9ucyB8fCBbXTtcbiAgICAgICAgY29uc3QgZXhwZWN0ZWQgPSAobW9jayBhcyBhbnkpLl9fZXhwZWN0ZWRJbnRlcmFjdGlvbnMgfHwgW107XG4gICAgICAgIGNvbnN0IHVuZXhwZWN0ZWQgPSBpbnRlcmFjdGlvbnMuZmlsdGVyKChpOiBhbnkpID0+ICFleHBlY3RlZC5pbmNsdWRlcyhpLm1ldGhvZCkpO1xuICAgICAgICBleHBlY3QodW5leHBlY3RlZCkudG9IYXZlTGVuZ3RoKDApO1xuICAgICAgICByZXR1cm4gZXhwZWN0YXRpb25zO1xuICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4gZXhwZWN0YXRpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IGFsbCBtb2NrcyAtIHVzZWZ1bCBmb3IgdGVzdCBpc29sYXRpb25cbiAgICovXG4gIHJlc2V0QWxsTW9ja3MobW9ja3M6IFJlY29yZDxzdHJpbmcsIGFueT4pIHtcbiAgICBPYmplY3QudmFsdWVzKG1vY2tzKS5mb3JFYWNoKG1vY2sgPT4ge1xuICAgICAgaWYgKG1vY2sgJiYgdHlwZW9mIG1vY2sgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIE9iamVjdC52YWx1ZXMobW9jaykuZm9yRWFjaChtZXRob2QgPT4ge1xuICAgICAgICAgIGlmIChqZXN0LmlzTW9ja0Z1bmN0aW9uKG1ldGhvZCkpIHtcbiAgICAgICAgICAgIChtZXRob2QgYXMgamVzdC5Nb2NrKS5tb2NrUmVzZXQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgLy8gQ2xlYXIgaW50ZXJhY3Rpb24gdHJhY2tpbmdcbiAgICAgICAgaWYgKG1vY2suX19pbnRlcmFjdGlvbnMpIHtcbiAgICAgICAgICBtb2NrLl9faW50ZXJhY3Rpb25zID0gW107XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdE1ldGhvZHMocHJvdG90eXBlOiBhbnkpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgbWV0aG9kczogc3RyaW5nW10gPSBbXTtcbiAgICBsZXQgY3VycmVudCA9IHByb3RvdHlwZTtcbiAgICBcbiAgICB3aGlsZSAoY3VycmVudCAmJiBjdXJyZW50ICE9PSBPYmplY3QucHJvdG90eXBlKSB7XG4gICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhjdXJyZW50KS5mb3JFYWNoKG5hbWUgPT4ge1xuICAgICAgICBpZiAobmFtZSAhPT0gJ2NvbnN0cnVjdG9yJyAmJiB0eXBlb2YgY3VycmVudFtuYW1lXSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIGlmICghbWV0aG9kcy5pbmNsdWRlcyhuYW1lKSkge1xuICAgICAgICAgICAgbWV0aG9kcy5wdXNoKG5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjdXJyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGN1cnJlbnQpO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gbWV0aG9kcztcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWV0aG9kTW9jayhtZXRob2ROYW1lOiBzdHJpbmcsIGNvbmZpZzogTW9ja0NvbmZpZ3VyYXRpb24pOiBqZXN0Lk1vY2sge1xuICAgIGNvbnN0IG1vY2sgPSBqZXN0LmZuKCk7XG4gICAgXG4gICAgaWYgKGNvbmZpZy5hdXRvR2VuZXJhdGUpIHtcbiAgICAgIC8vIEF1dG8tZ2VuZXJhdGUgcmVhc29uYWJsZSByZXR1cm4gdmFsdWVzIGJhc2VkIG9uIG1ldGhvZCBuYW1lXG4gICAgICBpZiAobWV0aG9kTmFtZS5zdGFydHNXaXRoKCdnZXQnKSB8fCBtZXRob2ROYW1lLnN0YXJ0c1dpdGgoJ2ZpbmQnKSkge1xuICAgICAgICBtb2NrLm1vY2tSZXNvbHZlZFZhbHVlKHt9KTtcbiAgICAgIH0gZWxzZSBpZiAobWV0aG9kTmFtZS5zdGFydHNXaXRoKCdpcycpIHx8IG1ldGhvZE5hbWUuc3RhcnRzV2l0aCgnaGFzJykpIHtcbiAgICAgICAgbW9jay5tb2NrUmV0dXJuVmFsdWUodHJ1ZSk7XG4gICAgICB9IGVsc2UgaWYgKG1ldGhvZE5hbWUuc3RhcnRzV2l0aCgnY3JlYXRlJykgfHwgbWV0aG9kTmFtZS5zdGFydHNXaXRoKCdzYXZlJykpIHtcbiAgICAgICAgbW9jay5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAnZ2VuZXJhdGVkLWlkJyB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbW9jaztcbiAgfVxuXG4gIHByaXZhdGUgYWRkSW50ZXJhY3Rpb25UcmFja2luZyhtb2NrT2JqOiBNb2NrT2JqZWN0KSB7XG4gICAgY29uc3QgaW50ZXJhY3Rpb25zOiBhbnlbXSA9IFtdO1xuICAgIG1vY2tPYmouX19pbnRlcmFjdGlvbnMgPSBpbnRlcmFjdGlvbnM7XG5cbiAgICAvLyBXcmFwIGFsbCBtb2NrIGZ1bmN0aW9ucyB0byB0cmFjayBpbnRlcmFjdGlvbnNcbiAgICBPYmplY3Qua2V5cyhtb2NrT2JqKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBjb25zdCBvcmlnaW5hbE1vY2sgPSBtb2NrT2JqW2tleV07XG4gICAgICBpZiAoamVzdC5pc01vY2tGdW5jdGlvbihvcmlnaW5hbE1vY2spKSB7XG4gICAgICAgIG1vY2tPYmpba2V5XSA9IGplc3QuZm4oKC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gICAgICAgICAgaW50ZXJhY3Rpb25zLnB1c2goe1xuICAgICAgICAgICAgbWV0aG9kOiBrZXksXG4gICAgICAgICAgICBhcmdzLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIG9yaWdpbmFsTW9jayguLi5hcmdzKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG1hdGNoSW50ZXJhY3Rpb25QYXR0ZXJuKGludGVyYWN0aW9uczogYW55W10sIHBhdHRlcm46IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIC8vIFNpbXBsZSBwYXR0ZXJuIG1hdGNoaW5nIGZvciBpbnRlcmFjdGlvbiBzZXF1ZW5jZXNcbiAgICAvLyBQYXR0ZXJuIGZvcm1hdDogXCJtZXRob2QxIC0+IG1ldGhvZDIgLT4gbWV0aG9kM1wiXG4gICAgY29uc3QgZXhwZWN0ZWRTZXF1ZW5jZSA9IHBhdHRlcm4uc3BsaXQoJyAtPiAnKS5tYXAocyA9PiBzLnRyaW0oKSk7XG4gICAgY29uc3QgYWN0dWFsU2VxdWVuY2UgPSBpbnRlcmFjdGlvbnMubWFwKGkgPT4gaS5tZXRob2QpO1xuICAgIFxuICAgIC8vIENoZWNrIGlmIGV4cGVjdGVkIHNlcXVlbmNlIGV4aXN0cyBpbiBhY3R1YWwgc2VxdWVuY2VcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBhY3R1YWxTZXF1ZW5jZS5sZW5ndGggLSBleHBlY3RlZFNlcXVlbmNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgbWF0Y2hlcyA9IHRydWU7XG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGV4cGVjdGVkU2VxdWVuY2UubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgaWYgKGFjdHVhbFNlcXVlbmNlW2kgKyBqXSAhPT0gZXhwZWN0ZWRTZXF1ZW5jZVtqXSkge1xuICAgICAgICAgIG1hdGNoZXMgPSBmYWxzZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKG1hdGNoZXMpIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLy8gQ29udmVuaWVuY2UgZnVuY3Rpb25zIGZvciBjb21tb24gcGF0dGVybnNcbmV4cG9ydCBjb25zdCBtb2NrQnVpbGRlciA9IE1vY2tCdWlsZGVyLmdldEluc3RhbmNlKCk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVMb25kb25Nb2Nrcyhjb25maWc/OiBQYXJ0aWFsPE1vY2tDb25maWd1cmF0aW9uPikge1xuICBjb25zdCBsb25kb25Db25maWc6IE1vY2tDb25maWd1cmF0aW9uID0ge1xuICAgIHN0cmF0ZWd5OiAnc3RyaWN0JyxcbiAgICB0cmFja0ludGVyYWN0aW9uczogdHJ1ZSxcbiAgICBhdXRvR2VuZXJhdGU6IHRydWUsXG4gICAgYXV0b1Jlc2V0OiB0cnVlLFxuICAgIC4uLmNvbmZpZ1xuICB9O1xuICBcbiAgcmV0dXJuIG5ldyBNb2NrQnVpbGRlcihsb25kb25Db25maWcpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ2xhc3NpY2FsTW9ja3MoY29uZmlnPzogUGFydGlhbDxNb2NrQ29uZmlndXJhdGlvbj4pIHtcbiAgY29uc3QgY2xhc3NpY2FsQ29uZmlnOiBNb2NrQ29uZmlndXJhdGlvbiA9IHtcbiAgICBzdHJhdGVneTogJ21pbmltYWwnLFxuICAgIHRyYWNrSW50ZXJhY3Rpb25zOiBmYWxzZSxcbiAgICBhdXRvR2VuZXJhdGU6IGZhbHNlLFxuICAgIGF1dG9SZXNldDogZmFsc2UsXG4gICAgLi4uY29uZmlnXG4gIH07XG4gIFxuICByZXR1cm4gbmV3IE1vY2tCdWlsZGVyKGNsYXNzaWNhbENvbmZpZyk7XG59Il0sInZlcnNpb24iOjN9