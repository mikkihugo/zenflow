#!/bin/sh
# Claude-Zen Smart Dispatcher - Detects and uses the best available runtime

# Get version from package.json
get_version() {
  if [ -f "$ROOT_DIR/package.json" ]; then
    VERSION=$(node -p "require('$ROOT_DIR/package.json').version" 2>/dev/null || echo "1.0.0-alpha.43")
  else
    VERSION="1.0.0-alpha.43"
  fi
}

# Determine the correct path based on how the script is invoked
if [ -L "$0" ]; then
  # Script is a symlink (npm global install)
  REAL_PATH=$(readlink -f "$0" 2>/dev/null || readlink "$0")
  SCRIPT_DIR=$(dirname "$REAL_PATH")
else
  # Script is executed directly
  SCRIPT_DIR=$(dirname "$0")
fi

# Handle global npm installation vs local execution
if [ -f "$SCRIPT_DIR/../src/interfaces/terminal/main.ts" ]; then
  # Local development or properly structured installation
  ROOT_DIR=$(cd "$SCRIPT_DIR/.." && pwd)
else
  # Global npm installation - files might be in different location
  # Try to find the module root
  NODE_ROOT=$(npm root -g 2>/dev/null)
  if [ -n "$NODE_ROOT" ] && [ -f "$NODE_ROOT/claude-zen/src/interfaces/terminal/main.ts" ]; then
    ROOT_DIR="$NODE_ROOT/claude-zen"
  else
    # Fallback to relative path
    ROOT_DIR=$(cd "$SCRIPT_DIR/.." && pwd)
  fi
fi

# No longer force help - let the main script handle default behavior
# If no arguments provided, main.ts will default to TUI mode

# Special handling for help command to ensure it passes through
if [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  # Let the actual CLI handle help display
  :  # no-op, just pass through
fi

# Get version dynamically
get_version

# Quick version check only - let the actual CLI handle help
for arg in "$@"; do
  if [ "$arg" = "--version" ] || [ "$arg" = "-v" ]; then
    echo "v$VERSION"
    exit 0
  fi
done

# Check if we should use development mode fallback 
should_use_dev_fallback() {
  for arg in "$@"; do
    case "$arg" in
      "discover"|"discover-*"|"--help"|"-h")
        return 0
        ;;
    esac
  done
  return 1
}

# Use Node.js - unified web+terminal experience
if [ "$1" = "web" ]; then
  # Use wrapper script with proper startup messages
  cd "$ROOT_DIR" && exec node claude-zen-wrapper.js "$@"
elif [ -z "$1" ] || [ "$1" = "tui" ]; then
  # Use proper React TUI with Ink (as originally intended)
  echo "üß† Claude-Zen v$VERSION: Starting terminal interface"
  cd "$ROOT_DIR" && exec npx tsx src/interfaces/terminal/main.ts --interactive
elif [ -f "$ROOT_DIR/src/main.ts" ]; then
  # Use development mode for other modes (more stable)
  echo "üß† Claude-Zen v$VERSION: Using development mode"
  cd "$ROOT_DIR" && exec npx tsx src/main.ts "$@"
elif [ -f "$ROOT_DIR/dist/claude-zen.js" ]; then
  # Try production build as fallback
  echo "üß† Claude-Zen v$VERSION: Using production build"
  cd "$ROOT_DIR" && exec node dist/claude-zen.js "$@"
else
  # Built files not found - this should trigger a build
  echo "üß† Claude-Zen v$VERSION - Distribution files not found"
  echo ""
  echo "‚ö†Ô∏è  Please build the project first:"
  echo "  npm run build"
  echo ""
  echo "For development mode only:"
  echo "  npx tsx src/interfaces/terminal/main.ts"
  echo ""
  echo "Documentation: https://github.com/mikkihugo/claude-code-zen"
  exit 1
fi